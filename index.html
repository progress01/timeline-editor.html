<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å ±å‘Šç¥å™¨ V18ï¼šé›™è¦–åœ–åˆ‡æ›ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f3f4f6;
            --text: #1f2937;
            --font-stack: "Microsoft JhengHei", "Heiti TC", sans-serif; 
        }

        body {
            font-family: var(--font-stack);
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            position: relative; 
            min-height: 100vh;
        }

        /* --- é ‚éƒ¨å·¥å…·åˆ— --- */
        .toolbar {
            position: fixed; top: 0; left: 0; right: 0;
            background: #1e293b; color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            height: 50px;
        }

        .tool-title { font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .save-status { font-size: 0.8rem; color: #94a3b8; margin-left: 10px; }
        
        .tool-btn-group { 
            display: flex; gap: 10px; 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
            margin-left: 20px; padding-right: 10px;
            align-items: center; height: 100%;
        }
        
        .tool-btn-group::-webkit-scrollbar { display: none; }
        
        .tool-btn {
            background: #334155; border: 1px solid #475569; color: white;
            padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; gap: 6px; transition: 0.2s;
            white-space: nowrap; flex-shrink: 0;
        }
        .tool-btn:hover { background: #475569; }
        .tool-btn.highlight { background: #7c3aed; border-color: #6d28d9; }
        .tool-btn.camera-btn { background: #059669; border-color: #047857; }
        .tool-btn.cal-btn { background: #ea580c; border-color: #c2410c; }
        .tool-btn.view-btn { background: #2563eb; border-color: #1d4ed8; } /* è¦–åœ–åˆ‡æ›æŒ‰éˆ•é¡è‰² */

        /* --- å·¦å´åœ–å½¢å·¥å…·ç®± --- */
        .toolbox {
            position: fixed; top: 80px; left: 20px; width: 80px;
            background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 8px; padding: 15px 5px;
            z-index: 1900; align-items: center;
        }
        .toolbox-header { font-size: 0.8rem; color: #64748b; font-weight:bold; margin: 5px 0 2px 0; border-bottom: 1px solid #eee; width: 100%; text-align: center; padding-bottom: 2px;}
        .tool-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 60px; padding: 5px 0; cursor: pointer; border-radius: 6px; transition: 0.2s;
            border: 1px solid transparent;
        }
        .tool-item:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .tool-icon { font-size: 1.4rem; line-height: 1; margin-bottom: 2px; }
        .tool-text { font-size: 0.75rem; color: #475569; }

        /* --- ä¸»å€åŸŸ --- */
        .main-area {
            max-width: 900px; margin: 60px auto 0 auto;
            padding: 40px 20px;
            min-height: calc(100vh - 100px);
            background: var(--bg);
        }

        /* --- è¦–åœ– 1: å‚ç›´æ™‚é–“è»¸ (Timeline) --- */
        .timeline { position: relative; padding: 20px 0; }
        .timeline::before {
            content: ''; position: absolute; top: 10px; bottom: 10px; left: 50%;
            width: 4px; background: #e5e7eb; transform: translateX(-50%);
            border-radius: 2px; z-index: 0; transition: left 0.3s;
        }

        .timeline-item {
            position: relative; margin-bottom: 30px; width: 100%;
            display: flex; justify-content: center; transition: all 0.5s ease;
        }
        .timeline-item .card { width: 45%; transition: margin 0.3s, width 0.3s; }
        
        .timeline-item:nth-child(odd) .card { margin-right: 50%; border-right: 4px solid transparent; }
        .timeline-item:nth-child(even) .card { margin-left: 50%; border-left: 4px solid transparent; }
        
        .timeline-item.force-left .card { margin-right: 50% !important; margin-left: 0 !important; border-right: 4px solid transparent; border-left: none; }
        .timeline-item.force-right .card { margin-left: 50% !important; margin-right: 0 !important; border-left: 4px solid transparent; border-right: none; }

        .card {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative; z-index: 10; border-top: 5px solid var(--primary);
        }
        
        .card[data-color="blue"] { border-top-color: #4f46e5; }
        .card[data-color="green"] { border-top-color: #10b981; background: #f0fdf4; }
        .card[data-color="red"] { border-top-color: #ef4444; background: #fef2f2; }
        .card[data-color="yellow"] { border-top-color: #f59e0b; background: #fffbeb; }

        .status-dot {
            position: absolute; top: 15px; left: 15px; width: 14px; height: 14px;
            border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);
        }
        .status-0 { background: #9ca3af; } .status-1 { background: #f59e0b; } .status-2 { background: #10b981; } .status-3 { background: #ef4444; }

        .card-body { margin-top: 15px; }
        .header-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }

        .date-input {
            border: 1px solid #cbd5e1; background: #f8fafc; padding: 4px 8px; border-radius: 6px;
            font-family: inherit; font-size: 0.85rem; color: #334155; outline: none; cursor: pointer;
            width: 115px;
        }
        .label-input {
            border: none; border-bottom: 1px dashed #cbd5e1; padding: 4px 8px; font-weight: bold;
            color: var(--primary); font-size: 0.9rem; outline: none; flex: 1; min-width: 80px;
        }

        .range-container { display: none; align-items: center; gap: 5px; font-size: 0.85rem; color: #555; flex-wrap: wrap;}
        .range-label { font-weight: bold; color: #64748b; font-size: 0.8rem; margin-right: 2px; }
        .timeline-item.range-mode .single-date { display: none; }
        .timeline-item.range-mode .range-container { display: flex; }

        .content { line-height: 1.6; color: #4b5563; outline: none; min-height: 1.5em; font-size: 0.95rem; }
        
        .dot {
            position: absolute; left: 50%; top: 25px; width: 14px; height: 14px; background: white;
            border: 4px solid #ccc; border-radius: 50%; transform: translateX(-50%); z-index: 20; transition: left 0.3s;
        }

        .controls {
            position: absolute; top: 5px; right: 5px; display: flex; gap: 3px;
            opacity: 0; transition: opacity 0.2s; background: rgba(255,255,255,0.95); padding: 3px; border-radius: 4px;
        }
        .card:hover .controls { opacity: 1; }
        .btn-icon {
            border: none; cursor: pointer; width: 26px; height: 26px;
            border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px;
        }
        .bg-gray { background: #64748b; } .bg-blue { background: #3b82f6; } .bg-red { background: #ef4444; } .bg-orange { background: #f97316; }

        /* --- è¦–åœ– 2: ç”˜ç‰¹åœ– (Gantt) --- */
        #gantt-view {
            display: none; /* é è¨­éš±è— */
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }

        .gantt-container {
            position: relative;
            min-width: 800px; /* æ‰‹æ©Ÿä¸Šå¯æ©«å‘æ²å‹•ï¼Œç¢ºä¿æ™‚é–“è»¸ä¸æ“ å£“ */
            padding-top: 40px; /* ç•™çµ¦ä¸Šæ–¹åˆ»åº¦ */
            padding-bottom: 20px;
        }

        .gantt-axis-labels {
            position: absolute; top: 0; left: 160px; right: 0; height: 30px;
            border-bottom: 1px solid #e2e8f0;
        }
        .gantt-axis-mark {
            position: absolute; top: 0; font-size: 0.75rem; color: #64748b; 
            border-left: 1px dashed #e2e8f0; height: 100vh; padding-left: 4px; pointer-events: none;
        }

        .gantt-row {
            position: relative; height: 40px; margin-bottom: 8px;
            display: flex; align-items: center; border-bottom: 1px dashed #f1f5f9;
        }
        
        .gantt-row:hover { background-color: #f8fafc; }

        .gantt-label-col {
            width: 150px; flex-shrink: 0; font-size: 0.85rem; font-weight: bold; color: #334155;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; text-align: right;
            border-right: 2px solid #e2e8f0; margin-right: 10px; line-height: 40px;
        }

        .gantt-bar-area {
            flex-grow: 1; position: relative; height: 100%;
        }

        .gantt-bar {
            position: absolute; top: 8px; height: 24px;
            border-radius: 4px; font-size: 0.75rem; color: white; white-space: nowrap;
            display: flex; align-items: center; padding: 0 8px; overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15); cursor: help;
            transition: all 0.2s;
        }
        
        .gantt-bar:hover {
            z-index: 100; min-width: max-content; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); transform: scaleY(1.1);
        }

        /* ç”˜ç‰¹åœ–é¡è‰²å°æ‡‰ */
        .gantt-bar[data-color="blue"] { background: #4f46e5; }
        .gantt-bar[data-color="green"] { background: #10b981; }
        .gantt-bar[data-color="red"] { background: #ef4444; }
        .gantt-bar[data-color="yellow"] { background: #f59e0b; color: #333; }

        .add-main {
            display: block; margin: 30px auto; padding: 12px 30px;
            background: var(--primary); color: white; border-radius: 30px;
            font-size: 1rem; border: none; cursor: pointer;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
            width: 100%; max-width: 300px;
        }

        .sticky-note, .sticker { position: absolute; z-index: 100; display: flex; flex-direction: column; cursor: grab; }
        .sticky-note:hover, .sticker:hover { z-index: 110; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        
        .sticky-note { width: 200px; min-height: 150px; padding: 0; border-radius: 2px; box-shadow: 3px 3px 10px rgba(0,0,0,0.2); border: 1px solid rgba(0,0,0,0.1); background: #fef08a; }
        .note-header { height: 20px; background: rgba(0,0,0,0.05); display: flex; justify-content: flex-end; padding-right: 5px; }
        .note-close { cursor: pointer; color: #666; font-weight: bold; font-size:14px; }
        .note-content { flex: 1; width: 100%; border: none; background: transparent; resize: none; padding: 10px; font-family: inherit; font-size: 0.95rem; outline: none; }

        .sticker { width: 80px; height: 80px; align-items: center; justify-content: center; }
        .sticker svg { width: 100%; height: 100%; overflow: visible; }
        .sticker-del { position: absolute; top: -10px; right: -10px; width: 20px; height: 20px; background: red; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; }
        .sticker:hover .sticker-del { display: flex; }


        /* =========================================
           ğŸ“± æ‰‹æ©Ÿç‰ˆå°ˆå±¬ CSS (éŸ¿æ‡‰å¼è¨­è¨ˆ)
           ========================================= */
        @media screen and (max-width: 768px) {
            body { padding: 10px; }
            .main-area { margin-top: 50px; padding: 10px 0; }
            .toolbox, .sticky-note, .sticker { display: none !important; }

            /* Timeline æ¨¡å¼ä¸‹çš„æ‰‹æ©Ÿä¿®æ­£ */
            .timeline::before { left: 20px; transform: none; }
            .dot { left: 20px; transform: none; margin-left: -7px; }

            .timeline-item { flex-direction: column; align-items: flex-end; width: 100%; margin-left: 0; }
            
            .timeline-item .card, 
            .timeline-item:nth-child(odd) .card, 
            .timeline-item:nth-child(even) .card,
            .timeline-item.force-left .card,
            .timeline-item.force-right .card {
                width: calc(100% - 50px) !important;
                margin: 0 0 20px 0 !important;
                border-left: none !important; border-right: none !important;
            }

            .controls { opacity: 1; background: rgba(243, 244, 246, 0.8); position: relative; top: 0; right: 0; justify-content: flex-end; margin-bottom: 10px; }
            .controls button[title*="é "], .controls button[title*="ç§»"] { display: none; }

            .header-row { align-items: flex-start; }
            .label-input { width: 100%; margin-top: 5px; }
            .btn-icon { width: 32px; height: 32px; font-size: 16px; }

            /* ç”˜ç‰¹åœ–æ‰‹æ©Ÿä¿®æ­£ */
            #gantt-view { padding: 10px; }
            .gantt-label-col { width: 100px; font-size: 0.75rem; } /* ç¸®å°å·¦å´æ¬„ä½ */
        }

        @media print { .toolbar, .toolbox, .controls, .add-main, .note-header, .sticker-del { display: none !important; } .sticky-note, .sticker { box-shadow: none; border: 1px solid transparent; } }
        body.screenshot-mode .toolbar, body.screenshot-mode .toolbox, body.screenshot-mode .controls, body.screenshot-mode .note-header, body.screenshot-mode .sticker-del, body.screenshot-mode .add-main { display: none !important; }

    </style>
</head>
<body>

    <div class="toolbar">
        <div class="tool-title">
            ğŸ§  V18
            <span class="save-status" id="saveStatus"></span>
        </div>
        <div class="tool-btn-group">
            <button class="tool-btn view-btn" onclick="toggleView()" id="viewBtn">ğŸ“Š åˆ‡æ›ç”˜ç‰¹åœ–</button>
            <button class="tool-btn cal-btn" onclick="exportToCSV()">ğŸ“… CSV</button>
            <button class="tool-btn highlight" onclick="sortByDate()">ğŸ“… æ’åº</button>
            <button class="tool-btn" onclick="copyText()">ğŸ“‹ æ–‡å­—</button>
            <button class="tool-btn camera-btn" onclick="takeScreenshot()">ğŸ“¸ æˆªåœ–</button>
            <button class="tool-btn" onclick="downloadJSON()">ğŸ“¥ å‚™ä»½</button>
            <button class="tool-btn" onclick="document.getElementById('fileInput').click()">ğŸ“¤ è®€å–</button>
            <input type="file" id="fileInput" hidden onchange="loadJSON(this)">
        </div>
    </div>

    <div class="toolbox">
        <div class="toolbox-header">ä¾¿åˆ©è²¼</div>
        <div class="tool-item" onclick="addStickyNote()"><span class="tool-icon">ğŸ“</span><span class="tool-text">æ–°å¢</span></div>
        <div class="toolbox-header">ç®­é ­</div>
        <div class="tool-item" onclick="addSticker('arrow-right')"><span class="tool-icon">â¡ï¸</span><span class="tool-text">å‘å³</span></div>
        <div class="tool-item" onclick="addSticker('arrow-down')"><span class="tool-icon">â¬‡ï¸</span><span class="tool-text">å‘ä¸‹</span></div>
        <div class="tool-item" onclick="addSticker('arrow-left')"><span class="tool-icon">â¬…ï¸</span><span class="tool-text">å‘å·¦</span></div>
        <div class="toolbox-header">é‡é»</div>
        <div class="tool-item" onclick="addSticker('circle-red')"><span class="tool-icon">â­•</span><span class="tool-text">ç´…åœˆ</span></div>
        <div class="tool-item" onclick="addSticker('rect-blue')"><span class="tool-icon">ğŸŸ¦</span><span class="tool-text">è—æ¡†</span></div>
    </div>

    <div class="main-area">
        <div class="timeline" id="container"></div>

        <div id="gantt-view">
            <div style="text-align:center; color:#888; margin-bottom:10px; font-size:0.8rem;">
                ğŸ’¡ å·¦å³æ»‘å‹•å¯æŸ¥çœ‹å®Œæ•´æ™‚é–“è»¸
            </div>
            <div class="gantt-container" id="ganttChart"></div>
        </div>

        <button class="add-main" id="mainAddBtn">ï¼‹ æ–°å¢ç¯€é»</button>
    </div>

    <script>
        const container = document.getElementById('container');
        const saveStatus = document.getElementById('saveStatus');

        const defaultData = [
            { id: 1, pos: 'left', mode: 'normal', color: 'blue', status: 0, label: 'æ‰‹æ©Ÿç‰ˆ', date_single: '2025-01-01', date_start: '', date_end: '', content: 'ç”¨æ‰‹æ©Ÿæ‰“é–‹é€™å€‹ç¶²é çœ‹çœ‹ï¼' },
            { id: 2, pos: 'right', mode: 'range', color: 'green', status: 0, label: 'é•·æ™‚é–“æ¸¬è©¦', date_single: '', date_start: '2025-02-01', date_end: '2025-06-05', content: 'é€™å€‹äº‹ä»¶è·¨è¶Šäº†å¥½å¹¾å€‹æœˆï¼Œåˆ‡æ›åˆ°ç”˜ç‰¹åœ–çœ‹çœ‹æ•ˆæœï¼' },
            { id: 3, pos: 'left', mode: 'range', color: 'red', status: 2, label: 'é‡ç–Šäº‹ä»¶', date_single: '', date_start: '2025-03-01', date_end: '2025-04-01', content: 'é€™æ®µæ™‚é–“è·Ÿä¸Šé¢æœ‰é‡ç–Šå–”ã€‚' }
        ];

        function init() {
            const savedData = localStorage.getItem('timeline_v18_data');
            const savedNotes = localStorage.getItem('timeline_v18_notes');
            const savedStickers = localStorage.getItem('timeline_v18_stickers');

            if (savedData) renderFromData(JSON.parse(savedData));
            else renderFromData(defaultData);

            if (savedNotes) renderNotes(JSON.parse(savedNotes));
            if (savedStickers) renderStickers(JSON.parse(savedStickers));
        }

        // --- è¦–åœ–åˆ‡æ›é‚è¼¯ (V18æ ¸å¿ƒ) ---
        let currentView = 'timeline';

        function toggleView() {
            const tl = document.getElementById('container');
            const gt = document.getElementById('gantt-view');
            const btn = document.getElementById('viewBtn');
            const addBtn = document.getElementById('mainAddBtn');

            if (currentView === 'timeline') {
                // åˆ‡æ›åˆ°ç”˜ç‰¹åœ–
                tl.style.display = 'none';
                gt.style.display = 'block';
                addBtn.style.display = 'none'; // ç”˜ç‰¹åœ–æ¨¡å¼ä¸‹éš±è—æ–°å¢æŒ‰éˆ• (é¿å…é‚è¼¯æ··äº‚)
                btn.innerHTML = 'ğŸ“ åˆ‡æ›åˆ—è¡¨';
                btn.classList.remove('view-btn');
                btn.classList.add('highlight');
                renderGantt(); 
                currentView = 'gantt';
            } else {
                // åˆ‡æ›å›åˆ—è¡¨
                tl.style.display = 'block';
                gt.style.display = 'none';
                addBtn.style.display = 'block';
                btn.innerHTML = 'ğŸ“Š åˆ‡æ›ç”˜ç‰¹åœ–';
                btn.classList.add('view-btn');
                btn.classList.remove('highlight');
                currentView = 'timeline';
            }
        }

        function renderGantt() {
            const chart = document.getElementById('ganttChart');
            chart.innerHTML = '';
            
            let data = gatherData();
            if (data.length === 0) { chart.innerHTML = '<div style="padding:20px; text-align:center;">ç„¡è³‡æ–™</div>'; return; }

            // 1. è™•ç†ä¸¦éæ¿¾ç„¡æ•ˆæ—¥æœŸ
            let validData = data.map(item => {
                let start, end;
                if (item.mode === 'range' && item.date_start) {
                    start = new Date(item.date_start).getTime();
                    end = item.date_end ? new Date(item.date_end).getTime() : start;
                } else if (item.date_single) {
                    start = new Date(item.date_single).getTime();
                    end = start; 
                }
                // ç¢ºä¿ end >= start
                if(end < start) end = start;

                return { ...item, start, end, isValid: (start && !isNaN(start)) };
            }).filter(item => item.isValid);

            if(validData.length === 0) { chart.innerHTML = '<div style="padding:20px; text-align:center;">è«‹å…ˆè¨­å®šå¡ç‰‡æ—¥æœŸ</div>'; return; }

            // ä¾é–‹å§‹æ™‚é–“æ’åº
            validData.sort((a,b) => a.start - b.start);

            // 2. è¨ˆç®—æ™‚é–“é‚Šç•Œ (åŠ å…¥ç·©è¡)
            let minT = Math.min(...validData.map(d => d.start));
            let maxT = Math.max(...validData.map(d => d.end));
            
            // é¿å…å–®ä¸€æ—¥é€ æˆ max=min
            if(maxT === minT) { maxT += 86400000 * 5; minT -= 86400000 * 5; }
            
            const duration = maxT - minT;
            const padding = duration * 0.05; // 5% å·¦å³ç·©è¡
            const plotStart = minT - padding;
            const plotEnd = maxT + padding;
            const plotDur = plotEnd - plotStart;

            // 3. ç¹ªè£½æ™‚é–“è»¸åˆ»åº¦ç·š (èƒŒæ™¯)
            let axisHtml = '';
            // ç°¡æ˜“æ¼”ç®—æ³•ï¼šåˆ‡æˆ 5 ç­‰åˆ†
            for(let i=0; i<=5; i++){
                const percent = i * 20;
                const timeAtLine = plotStart + (plotDur * (i/5));
                const d = new Date(timeAtLine);
                const dateLabel = `${d.getFullYear()}/${d.getMonth()+1}`;
                
                axisHtml += `<div class="gantt-axis-mark" style="left: ${150 + (percent/100 * (100-20))}% /* ä¿®æ­£å·¦é‚Šè· */;"></div>`;
                // ä¸Šæ–¹æ¨™ç±¤ (æš«æ™‚ç°¡åŒ–)
            }
            
            // 4. ç¹ªè£½æ¯ä¸€å€‹ Bar
            let rowsHtml = '';
            validData.forEach(item => {
                const startPct = ((item.start - plotStart) / plotDur) * 100;
                let widthPct = ((item.end - item.start) / plotDur) * 100;
                
                // å–®æ—¥äº‹ä»¶çµ¦äºˆæœ€å°å¯¬åº¦ (ä¾‹å¦‚ 1%)
                if (widthPct < 1) widthPct = 1; 

                // æ¨™é¡Œå¦‚æœå¤ªé•·
                const label = item.label || 'ç„¡æ¨™é¡Œ';
                const dateInfo = item.mode==='range' ? `${item.date_start}~${item.date_end}` : item.date_single;

                rowsHtml += `
                <div class="gantt-row">
                    <div class="gantt-label-col" title="${label}">${label}</div>
                    <div class="gantt-bar-area">
                        <div class="gantt-bar" data-color="${item.color}" 
                             style="left: ${startPct}%; width: ${widthPct}%;"
                             title="${label} (${dateInfo})\n${item.content.substring(0,50)}...">
                             ${label}
                        </div>
                    </div>
                </div>`;
            });

            // çµ„åˆ
            // è£œä¸Šåˆ»åº¦æ¨™ç±¤
            let marksHtml = '';
            for(let i=0; i<=5; i++) {
                const percent = i * 20;
                const timeAtLine = plotStart + (plotDur * (i/5));
                const d = new Date(timeAtLine);
                marksHtml += `<div style="position:absolute; top:5px; font-size:10px; color:#999; transform:translateX(-50%); left:${percent}%;">${d.getFullYear()}/${d.getMonth()+1}</div>`;
            }

            chart.innerHTML = `
                <div class="gantt-axis-labels" style="padding-left:150px; position:relative; height:20px; margin-bottom:10px;">
                    <div style="position:relative; width:100%; height:100%;">
                        ${marksHtml}
                    </div>
                </div>
                ${rowsHtml}
            `;
        }


        // --- åŸæœ‰åŠŸèƒ½ --- 
        function addToGoogleCal(btn) {
            const itemEl = btn.closest('.timeline-item');
            const isRange = itemEl.classList.contains('range-mode');
            let title = itemEl.querySelector('.label-input').value || 'æœªå‘½åäº‹ä»¶';
            let desc = itemEl.querySelector('.content').innerText;
            let startDate, endDate;
            if (isRange) { startDate = itemEl.querySelector('.date-start').value; endDate = itemEl.querySelector('.date-end').value; } 
            else { startDate = itemEl.querySelector('.single-date').value; endDate = startDate; }
            if(!startDate) { alert('è«‹å…ˆé¸æ“‡æ—¥æœŸï¼'); return; }
            const startStr = startDate.replace(/-/g, '');
            let endObj = new Date(endDate); endObj.setDate(endObj.getDate() + 1);
            const endStr = endObj.toISOString().slice(0,10).replace(/-/g, '');
            const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startStr}/${endStr}&details=${encodeURIComponent(desc)}`;
            window.open(url, '_blank');
        }

        function exportToCSV() {
            let csvContent = "Subject,Start Date,End Date,All Day Event,Description\n";
            gatherData().forEach(item => {
                let title = (item.label || 'æœªå‘½åäº‹ä»¶').replace(/,/g, 'ï¼Œ');
                let desc = item.content.replace(/,/g, 'ï¼Œ').replace(/\n/g, ' '); 
                let start = item.mode === 'range' ? item.date_start : item.date_single;
                let end = item.mode === 'range' ? item.date_end : item.date_single;
                if(start && end) {
                    let endObj = new Date(end); endObj.setDate(endObj.getDate() + 1);
                    let endNextDay = endObj.toISOString().slice(0,10);
                    csvContent += `${title},${start},${endNextDay},True,${desc}\n`;
                }
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `google_calendar_import_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function createNodeElement(item) {
            const div = document.createElement('div');
            div.className = `timeline-item ${item.pos==='left'?'force-left':item.pos==='right'?'force-right':''} ${item.mode==='range'?'range-mode':''}`;
            div.innerHTML = `
                <div class="dot"></div>
                <div class="card" data-color="${item.color}">
                    <div class="status-dot status-${item.status}" onclick="cycleStatus(this)" title="åˆ‡æ›ç‹€æ…‹"></div>
                    <div class="controls">
                        <button class="btn-icon bg-gray" onclick="changeColor(this)" title="æ›è‰²">ğŸ¨</button>
                        <button class="btn-icon bg-gray" onclick="moveNode(this,'up')" title="ä¸Šç§»">â¬†ï¸</button>
                        <button class="btn-icon bg-gray" onclick="moveNode(this,'down')" title="ä¸‹ç§»">â¬‡ï¸</button>
                        <button class="btn-icon bg-gray" onclick="togglePos(this,'left')" title="é å·¦">â¬…ï¸</button>
                        <button class="btn-icon bg-gray" onclick="togglePos(this,'right')" title="é å³">â¡ï¸</button>
                        <button class="btn-icon bg-blue" onclick="toggleRange(this)" title="åˆ‡æ›æ™‚æ®µ">â†”ï¸</button>
                        <button class="btn-icon bg-orange" onclick="addToGoogleCal(this)" title="åŠ åˆ°æ—¥æ›†">ğŸ“…</button>
                        <button class="btn-icon bg-red" onclick="deleteNode(this)" title="åˆªé™¤">Ã—</button>
                    </div>
                    <div class="card-body">
                        <div class="header-row">
                            <input type="date" class="date-input single-date" value="${item.date_single}" onchange="autoSave()" title="æ—¥æœŸ">
                            <div class="range-container">
                                <span class="range-label">èµ·:</span><input type="date" class="date-input date-start" value="${item.date_start}" onchange="autoSave()">
                                <span class="range-label">è¿„:</span><input type="date" class="date-input date-end" value="${item.date_end}" onchange="autoSave()">
                            </div>
                            <input type="text" class="label-input" value="${item.label}" placeholder="æ¨™é¡Œ" oninput="autoSave()">
                        </div>
                        <div class="content" contenteditable="true" oninput="autoSave()">${item.content}</div>
                    </div>
                </div>`;
            return div;
        }

        function copyText() {
            let text = "ã€æ™‚é–“è»¸å ±å‘Šã€‘\n\n";
            gatherData().forEach(item => {
                let dateStr = item.mode === 'range' ? `(èµ·)${item.date_start} ~ (è¿„)${item.date_end}` : item.date_single;
                let statusIcon = ['âšª', 'ğŸŸ¡', 'ğŸŸ¢', 'ğŸ”´'][item.status]; 
                text += `${statusIcon} ${dateStr} [${item.label || 'ç„¡æ¨™é¡Œ'}]\n   ${item.content}\n\n`;
            });
            const notes = gatherNotes();
            if(notes.length > 0) { text += "----------------\nã€éš¨æ‰‹ç­†è¨˜ã€‘\n"; notes.forEach(note => { text += `â€¢ ${note.content.replace(/\n/g, ' ')}\n`; }); }
            navigator.clipboard.writeText(text).then(() => { alert('è¤‡è£½æˆåŠŸï¼'); });
        }

        function takeScreenshot() {
            if(currentView === 'gantt') { alert('å»ºè­°åˆ‡æ›å›åˆ—è¡¨æ¨¡å¼å†æˆªåœ–ï¼Œæ•ˆæœè¼ƒå¥½ï¼'); }
            document.body.classList.add('screenshot-mode'); window.scrollTo(0, 0); saveStatus.innerText = 'è™•ç†ä¸­...';
            html2canvas(document.body, { backgroundColor: '#f3f4f6', scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a'); link.download = `report_${new Date().toISOString().slice(0,10)}.png`; link.href = canvas.toDataURL(); link.click();
                document.body.classList.remove('screenshot-mode'); saveStatus.innerText = '';
            }).catch(err => { document.body.classList.remove('screenshot-mode'); alert('æˆªåœ–éŒ¯èª¤'); });
        }

        const stickerSVGs = {
            'arrow-right': '<svg viewBox="0 0 100 100" fill="none" stroke="#334155" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"><path d="M10 50h80m-30-30l30 30-30 30"/></svg>',
            'arrow-down': '<svg viewBox="0 0 100 100" fill="none" stroke="#334155" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"><path d="M50 10v80m-30-30l30 30 30-30"/></svg>',
            'arrow-left': '<svg viewBox="0 0 100 100" fill="none" stroke="#334155" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"><path d="M90 50H10m30-30L10 50l30 30"/></svg>',
            'circle-red': '<svg viewBox="0 0 100 100" fill="none" stroke="#ef4444" stroke-width="6"><circle cx="50" cy="50" r="40"/></svg>',
            'rect-blue': '<svg viewBox="0 0 100 100" fill="none" stroke="#3b82f6" stroke-width="6" stroke-dasharray="10 5"><rect x="10" y="20" width="80" height="60" rx="5"/></svg>'
        };
        function addSticker(type) { createStickerElement({ id: Date.now(), type: type, x: 150 + window.scrollY, y: 150 + window.scrollY }); autoSave(); }
        function createStickerElement(sticker) {
            const div = document.createElement('div'); div.className = 'sticker'; div.style.left = sticker.x + 'px'; div.style.top = sticker.y + 'px'; div.setAttribute('id', 'sticker-' + sticker.id); div.dataset.type = sticker.type;
            div.innerHTML = `${stickerSVGs[sticker.type]}<div class="sticker-del" onclick="deleteSticker(this)">âœ•</div>`; div.onmousedown = function(e) { dragMouseDown(e, div); }; document.body.appendChild(div);
        }
        function deleteSticker(btn) { btn.closest('.sticker').remove(); autoSave(); event.stopPropagation(); }
        function addStickyNote() { createStickyElement({ id: Date.now(), x: 250, y: 200 + window.scrollY, content: '' }); autoSave(); }
        function createStickyElement(note) {
            const div = document.createElement('div'); div.className = 'sticky-note'; div.style.left = note.x + 'px'; div.style.top = note.y + 'px'; div.setAttribute('id', 'note-' + note.id);
            div.innerHTML = `<div class="note-header" onmousedown="dragMouseDown(event, this.parentNode)"><span class="note-close" onclick="deleteSticky(this)">Ã—</span></div><textarea class="note-content" oninput="autoSave()" placeholder="ç­†è¨˜...">${note.content}</textarea>`; document.body.appendChild(div);
        }
        function deleteSticky(btn) { if(confirm('åˆªé™¤?')) { btn.closest('.sticky-note').remove(); autoSave(); } }

        let pos1=0,pos2=0,pos3=0,pos4=0;
        window.dragMouseDown = function(e, elmnt) {
            if(e.target.tagName==='BUTTON'||e.target.tagName==='TEXTAREA'||e.target.className==='sticker-del') return;
            e = e || window.event; e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY;
            document.onmouseup = function() { document.onmouseup=null; document.onmousemove=null; autoSave(); };
            document.onmousemove = function(e) { e = e || window.event; e.preventDefault(); pos1=pos3-e.clientX; pos2=pos4-e.clientY; pos3=e.clientX; pos4=e.clientY; elmnt.style.top=(elmnt.offsetTop-pos2)+"px"; elmnt.style.left=(elmnt.offsetLeft-pos1)+"px"; };
        }

        function renderFromData(data) { container.innerHTML = ''; data.forEach(item => container.appendChild(createNodeElement(item))); }
        function renderNotes(n){document.querySelectorAll('.sticky-note').forEach(e=>e.remove());n.forEach(x=>createStickyElement(x));}
        function renderStickers(s){document.querySelectorAll('.sticker').forEach(e=>e.remove());s.forEach(x=>createStickerElement(x));}
        
        window.sortByDate = function() {
            const items = Array.from(container.children);
            items.sort((a,b)=>{ const gd=(el)=>new Date(el.classList.contains('range-mode')?el.querySelector('.date-start').value:el.querySelector('.single-date').value).getTime()||9e13; return gd(a)-gd(b); });
            items.forEach(i=>container.appendChild(i)); autoSave(); alert('å·²æŒ‰æ—¥æœŸé †åºæ’åˆ—ï¼');
        }
        window.cycleStatus=function(el){const c=['status-0','status-1','status-2','status-3']; let cur=c.find(x=>el.classList.contains(x))||'status-0'; el.className=`status-dot ${c[(c.indexOf(cur)+1)%4]}`; autoSave();}
        window.changeColor=function(btn){const card=btn.closest('.card'); const c=['blue','green','yellow','red']; card.setAttribute('data-color', c[(c.indexOf(card.getAttribute('data-color'))+1)%4]); autoSave();}
        window.togglePos=function(btn,dir){const i=btn.closest('.timeline-item'); if(dir==='left'){i.classList.add('force-left');i.classList.remove('force-right');}else{i.classList.add('force-right');i.classList.remove('force-left');} autoSave();}
        window.toggleRange=function(btn){btn.closest('.timeline-item').classList.toggle('range-mode'); autoSave();}
        window.deleteNode=function(btn){if(confirm('åˆªé™¤?')){btn.closest('.timeline-item').remove(); autoSave();}}
        window.moveNode=function(btn,dir){const i=btn.closest('.timeline-item'); if(dir==='up'&&i.previousElementSibling)i.parentNode.insertBefore(i,i.previousElementSibling);else if(dir==='down'&&i.nextElementSibling)i.parentNode.insertBefore(i,i.nextElementSibling.nextSibling); autoSave();}
        document.getElementById('mainAddBtn').addEventListener('click',()=>{const t=new Date().toISOString().split('T')[0]; container.appendChild(createNodeElement({id:Date.now(),pos:'auto',mode:'normal',color:'blue',status:0,label:'',date_single:t,date_start:t,date_end:t,content:'å…§å®¹...'})); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); autoSave();});
        
        function gatherData() {
            const items = []; container.querySelectorAll('.timeline-item').forEach(el => {
                const card=el.querySelector('.card'); const statusEl=el.querySelector('.status-dot');
                let status=0; ['status-1','status-2','status-3'].forEach((c,i)=>{if(statusEl.classList.contains(c))status=i+1;});
                let pos='auto'; if(el.classList.contains('force-left'))pos='left'; if(el.classList.contains('force-right'))pos='right';
                items.push({pos, mode:el.classList.contains('range-mode')?'range':'normal', color:card.getAttribute('data-color'), status, label:el.querySelector('.label-input').value, date_single:el.querySelector('.single-date').value, date_start:el.querySelector('.date-start').value, date_end:el.querySelector('.date-end').value, content:el.querySelector('.content').innerText});
            }); return items;
        }
        function gatherNotes(){const n=[]; document.querySelectorAll('.sticky-note').forEach(el=>{n.push({id:el.id.replace('note-',''),x:el.offsetLeft,y:el.offsetTop,content:el.querySelector('.note-content').value});}); return n;}
        function gatherStickers(){const l=[]; document.querySelectorAll('.sticker').forEach(el=>{l.push({id:el.id.replace('sticker-',''),type:el.dataset.type,x:el.offsetLeft,y:el.offsetTop});}); return l;}
        function autoSave() {
            // V18 å„²å­˜ Key
            localStorage.setItem('timeline_v18_data', JSON.stringify(gatherData()));
            localStorage.setItem('timeline_v18_notes', JSON.stringify(gatherNotes()));
            localStorage.setItem('timeline_v18_stickers', JSON.stringify(gatherStickers()));
            saveStatus.innerText = 'å·²å„²å­˜'; setTimeout(() => saveStatus.innerText = '', 2000);
        }
        window.downloadJSON=function(){const d={timeline:gatherData(),notes:gatherNotes(),stickers:gatherStickers(),version:'v18'}; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json;charset=utf-8'})); a.download=`timeline_v18_${new Date().toISOString().slice(0,10)}.json`; a.click();}
        window.loadJSON=function(inp){const f=inp.files[0]; if(!f)return; const r=new FileReader(); r.onload=function(e){try{const j=JSON.parse(e.target.result); if(j.timeline){renderFromData(j.timeline); if(j.notes)renderNotes(j.notes); if(j.stickers)renderStickers(j.stickers); autoSave(); alert('è®€å–æˆåŠŸ');}}catch(x){alert('æ ¼å¼éŒ¯èª¤');}}; r.readAsText(f);}

        init();
    </script>
</body>
</html>
