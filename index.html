<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±å‘Šç¥å™¨ V9ï¼šæœˆæ›†é¸å–®ç‰ˆ</title>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f3f4f6;
            --text: #1f2937;
            --status-gray: #9ca3af;
            --status-yellow: #f59e0b;
            --status-green: #10b981;
            --status-red: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- å·¥å…·åˆ— --- */
        .toolbar {
            position: fixed; top: 0; left: 0; right: 0;
            background: #1e293b; color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .tool-title { font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .save-status { font-size: 0.8rem; color: #94a3b8; margin-left: 10px; }
        .tool-btn-group { display: flex; gap: 10px; }
        
        .tool-btn {
            background: #334155; border: 1px solid #475569; color: white;
            padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .tool-btn:hover { background: #475569; }
        .tool-btn.highlight { background: #7c3aed; border-color: #6d28d9; }
        .tool-btn.highlight:hover { background: #6d28d9; }

        /* --- ä¸»å€åŸŸ --- */
        .main-area {
            flex: 1; margin-top: 50px; margin-right: 320px;
            overflow-y: auto; padding: 40px 20px; height: calc(100vh - 100px);
        }

        .timeline { position: relative; max-width: 800px; margin: 0 auto; padding: 20px 0; }
        .timeline::before {
            content: ''; position: absolute; top: 10px; bottom: 10px; left: 50%;
            width: 4px; background: #e5e7eb; transform: translateX(-50%);
            border-radius: 2px; z-index: 0;
        }

        .timeline-item {
            position: relative; margin-bottom: 30px; width: 100%;
            display: flex; justify-content: center; transition: all 0.5s ease;
        }
        .timeline-item .card { width: 45%; transition: margin 0.3s; }
        .timeline-item:nth-child(odd) .card { margin-right: 50%; border-right: 4px solid transparent; }
        .timeline-item:nth-child(even) .card { margin-left: 50%; border-left: 4px solid transparent; }
        
        .timeline-item.force-left .card { margin-right: 50% !important; margin-left: 0 !important; border-right: 4px solid transparent; border-left: none; }
        .timeline-item.force-right .card { margin-left: 50% !important; margin-right: 0 !important; border-left: 4px solid transparent; border-right: none; }

        .card {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative; z-index: 10; border-top: 5px solid var(--primary);
        }
        
        /* é¡è‰²æ§åˆ¶ */
        .card[data-color="blue"] { border-top-color: #4f46e5; }
        .card[data-color="green"] { border-top-color: #10b981; background: #f0fdf4; }
        .card[data-color="red"] { border-top-color: #ef4444; background: #fef2f2; }
        .card[data-color="yellow"] { border-top-color: #f59e0b; background: #fffbeb; }
        .card[data-color="purple"] { border-top-color: #8b5cf6; background: #f5f3ff; }

        .status-dot {
            position: absolute; top: 15px; left: 15px; width: 12px; height: 12px;
            border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);
        }
        .status-0 { background: var(--status-gray); }
        .status-1 { background: var(--status-yellow); }
        .status-2 { background: var(--status-green); }
        .status-3 { background: var(--status-red); }

        .card-body { margin-top: 15px; }

        /* --- æ–°ç‰ˆæ¨™é ­è¨­è¨ˆ (æ—¥æœŸé¸å–®) --- */
        .header-row {
            display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;
        }

        /* æ—¥æœŸé¸æ“‡å™¨æ¨£å¼ */
        .date-input {
            border: 1px solid #cbd5e1; background: #f8fafc;
            padding: 4px 8px; border-radius: 6px;
            font-family: inherit; font-size: 0.85rem; color: #334155;
            outline: none; cursor: pointer;
        }
        .date-input:focus { border-color: var(--primary); background: white; }

        /* æ¨™é¡Œè¼¸å…¥æ¡† */
        .label-input {
            border: none; border-bottom: 1px dashed #cbd5e1;
            padding: 4px 8px; font-weight: bold; color: var(--primary);
            font-size: 0.9rem; outline: none; flex: 1; min-width: 80px;
        }
        .label-input:focus { border-bottom-style: solid; }

        /* æ™‚æ®µæ¨¡å¼å®¹å™¨ */
        .range-container { display: none; align-items: center; gap: 5px; font-size: 0.85rem; color: #555; }
        .timeline-item.range-mode .single-date { display: none; } /* éš±è—å–®ä¸€æ—¥æœŸ */
        .timeline-item.range-mode .range-container { display: flex; } /* é¡¯ç¤ºæ™‚æ®µ */

        .content { line-height: 1.6; color: #4b5563; outline: none; min-height: 1.5em; font-size: 0.95rem; }
        
        .dot {
            position: absolute; left: 50%; top: 25px; width: 14px; height: 14px; background: white;
            border: 4px solid #ccc; border-radius: 50%; transform: translateX(-50%); z-index: 20;
        }

        .controls {
            position: absolute; top: 5px; right: 5px; display: flex; gap: 3px;
            opacity: 0; transition: opacity 0.2s; background: rgba(255,255,255,0.9); padding: 3px; border-radius: 4px;
        }
        .card:hover .controls { opacity: 1; }
        
        .btn-icon {
            border: none; cursor: pointer; width: 24px; height: 24px;
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 12px;
        }
        .bg-gray { background: #64748b; }
        .bg-blue { background: #3b82f6; }
        .bg-red { background: #ef4444; }

        .add-main {
            display: block; margin: 30px auto; padding: 12px 30px;
            background: var(--primary); color: white; border-radius: 30px;
            font-size: 1rem; border: none; cursor: pointer;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }

        .sticky-notes {
            position: fixed; top: 60px; right: 20px; bottom: 20px; width: 280px;
            background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 15px;
            box-shadow: -5px 0 15px rgba(0,0,0,0.05); display: flex; flex-direction: column;
        }
        .sticky-area { flex: 1; background: transparent; border: none; resize: none; font-family: inherit; color: #78350f; outline: none; }

        @media print {
            .toolbar, .controls, .add-main, .sticky-notes { display: none !important; }
            .main-area { margin: 0; height: auto; overflow: visible; }
            body { padding: 0; display: block; height: auto; }
            .timeline-item { break-inside: avoid; }
            /* åˆ—å°æ™‚ç§»é™¤ input é‚Šæ¡†ï¼Œè®“å®ƒçœ‹èµ·ä¾†åƒç´”æ–‡å­— */
            .date-input { border: none; background: transparent; padding: 0; appearance: none; }
            .label-input { border: none; }
            /* ä¿®æ­£åˆ—å°æ™‚ input å¯èƒ½ç‚ºç©ºçš„å•é¡Œï¼Œä½¿ç”¨ placeholder */
            ::-webkit-datetime-edit-fields-wrapper { pading: 0; }
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <div class="tool-title">
            ğŸ§  æ€ç·’ç®¡ç† V9
            <span class="save-status" id="saveStatus"></span>
        </div>
        <div class="tool-btn-group">
            <button class="tool-btn highlight" onclick="sortByDate()">ğŸ“… æŒ‰æ—¥æœŸæ’åº</button>
            <button class="tool-btn" onclick="downloadJSON()">ğŸ“¥ å‚™ä»½</button>
            <button class="tool-btn" onclick="document.getElementById('fileInput').click()">ğŸ“¤ è®€å–</button>
            <input type="file" id="fileInput" hidden onchange="loadJSON(this)">
            <button class="tool-btn primary" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
        </div>
    </div>

    <div class="main-area">
        <div class="timeline" id="container"></div>
        <button class="add-main" id="mainAddBtn">ï¼‹ æ–°å¢ç¯€é»</button>
    </div>

    <div class="sticky-notes">
        <div style="font-weight:bold; color:#b45309; margin-bottom:10px;">ğŸ“ ç­†è¨˜å€</div>
        <textarea class="sticky-area" id="stickyNotes" placeholder="ç¾åœ¨ä½ å¯ä»¥ç›´æ¥é»æ“Šæ—¥æ›†åœ–ç¤ºä¾†é¸æ“‡æ—¥æœŸï¼Œä¸ç”¨å†æ‰‹å‹•è¼¸å…¥äº†ï¼"></textarea>
    </div>

    <script>
        const container = document.getElementById('container');
        const stickyNotes = document.getElementById('stickyNotes');
        const saveStatus = document.getElementById('saveStatus');

        // é è¨­è³‡æ–™ï¼šä½¿ç”¨ value å„²å­˜æ¨™æº–æ—¥æœŸ (yyyy-mm-dd)
        const defaultData = [
            { id: 1, pos: 'left', mode: 'normal', color: 'blue', status: 0, label: 'å°ˆæ¡ˆå•Ÿå‹•', date_single: '2025-01-01', date_start: '', date_end: '', content: 'é»æ“Šæ—¥æœŸæ¡†æ¡†ï¼Œæœƒç›´æ¥è·³å‡ºæ—¥æ›†è®“ä½ é¸ã€‚' },
            { id: 2, pos: 'right', mode: 'range', color: 'green', status: 0, label: 'åŸ·è¡Œéšæ®µ', date_single: '', date_start: '2025-02-01', date_end: '2025-04-30', content: 'æ™‚æ®µæ¨¡å¼ç¾åœ¨æœ‰å…©å€‹æ—¥æœŸé¸æ“‡å™¨ï¼Œæ’åºæ™‚æœƒçœ‹ã€Œé–‹å§‹æ—¥æœŸã€ã€‚' }
        ];

        function init() {
            const savedData = localStorage.getItem('timeline_v9_data');
            const savedNotes = localStorage.getItem('timeline_v9_notes');
            if (savedNotes) stickyNotes.value = savedNotes;
            if (savedData) renderFromData(JSON.parse(savedData));
            else renderFromData(defaultData);
        }

        function renderFromData(data) {
            container.innerHTML = '';
            data.forEach(item => container.appendChild(createNodeElement(item)));
        }

        function createNodeElement(item) {
            const div = document.createElement('div');
            div.className = `timeline-item ${item.pos === 'left' ? 'force-left' : item.pos === 'right' ? 'force-right' : ''} ${item.mode === 'range' ? 'range-mode' : ''}`;
            
            div.innerHTML = `
                <div class="dot"></div>
                <div class="card" data-color="${item.color}">
                    <div class="status-dot status-${item.status}" onclick="cycleStatus(this)" title="åˆ‡æ›ç‹€æ…‹"></div>
                    
                    <div class="controls">
                        <button class="btn-icon bg-gray" onclick="changeColor(this)">ğŸ¨</button>
                        <button class="btn-icon bg-gray" onclick="moveNode(this, 'up')">â¬†ï¸</button>
                        <button class="btn-icon bg-gray" onclick="moveNode(this, 'down')">â¬‡ï¸</button>
                        <button class="btn-icon bg-gray" onclick="togglePos(this, 'left')">â¬…ï¸</button>
                        <button class="btn-icon bg-gray" onclick="togglePos(this, 'right')">â¡ï¸</button>
                        <button class="btn-icon bg-blue" onclick="toggleRange(this)">â†”ï¸</button>
                        <button class="btn-icon bg-red" onclick="deleteNode(this)">Ã—</button>
                    </div>

                    <div class="card-body">
                        <div class="header-row">
                            <input type="date" class="date-input single-date" value="${item.date_single}" onchange="autoSave()">
                            
                            <div class="range-container">
                                <input type="date" class="date-input date-start" value="${item.date_start}" onchange="autoSave()">
                                âœ 
                                <input type="date" class="date-input date-end" value="${item.date_end}" onchange="autoSave()">
                            </div>

                            <input type="text" class="label-input" value="${item.label}" placeholder="æ¨™é¡Œ (ä¾‹: Step 1)" oninput="autoSave()">
                        </div>

                        <div class="content" contenteditable="true" oninput="autoSave()">${item.content}</div>
                    </div>
                </div>
            `;
            return div;
        }

        /* --- æ ¸å¿ƒï¼šæ—¥æœŸæ’åºåŠŸèƒ½ (V9 æ”¹è‰¯ç‰ˆ) --- */
        window.sortByDate = function() {
            const items = Array.from(container.children);
            
            items.sort((a, b) => {
                const getDateVal = (el) => {
                    // ç›´æ¥è®€å– input çš„ valueï¼Œçµ•å°æº–ç¢º
                    let val = '';
                    if (el.classList.contains('range-mode')) {
                        val = el.querySelector('.date-start').value;
                    } else {
                        val = el.querySelector('.single-date').value;
                    }
                    // å¦‚æœæ²’é¸æ—¥æœŸï¼Œè¦–ç‚ºæœ€å¤§å€¼æ’å¾Œé¢
                    return val ? new Date(val).getTime() : 9999999999999;
                };
                return getDateVal(a) - getDateVal(b);
            });

            items.forEach(item => container.appendChild(item));
            autoSave();
            alert('å·²æ ¹æ“šæ—¥æœŸé¸å–®å®Œæˆæ’åºï¼');
        }

        /* --- é€šç”¨åŠŸèƒ½ --- */
        window.cycleStatus = function(el) {
            const classes = ['status-0', 'status-1', 'status-2', 'status-3'];
            let cur = classes.find(c => el.classList.contains(c)) || 'status-0';
            el.className = `status-dot ${classes[(classes.indexOf(cur) + 1) % classes.length]}`;
            autoSave();
        }

        window.changeColor = function(btn) {
            const card = btn.closest('.card');
            const colors = ['blue', 'green', 'yellow', 'red', 'purple'];
            const cur = card.getAttribute('data-color') || 'blue';
            card.setAttribute('data-color', colors[(colors.indexOf(cur) + 1) % colors.length]);
            autoSave();
        }

        window.togglePos = function(btn, dir) {
            const item = btn.closest('.timeline-item');
            if (dir === 'left') { item.classList.add('force-left'); item.classList.remove('force-right'); }
            else { item.classList.add('force-right'); item.classList.remove('force-left'); }
            autoSave();
        }

        window.toggleRange = function(btn) {
            btn.closest('.timeline-item').classList.toggle('range-mode');
            autoSave();
        }

        window.deleteNode = function(btn) { if(confirm('åˆªé™¤?')) { btn.closest('.timeline-item').remove(); autoSave(); } }

        window.moveNode = function(btn, dir) {
            const item = btn.closest('.timeline-item');
            if (dir === 'up' && item.previousElementSibling) item.parentNode.insertBefore(item, item.previousElementSibling);
            else if (dir === 'down' && item.nextElementSibling) item.parentNode.insertBefore(item, item.nextElementSibling.nextSibling);
            autoSave();
        }

        document.getElementById('mainAddBtn').addEventListener('click', () => {
            // é è¨­çµ¦ä»Šå¤©çš„æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            const newItem = { id: Date.now(), pos: 'auto', mode: 'normal', color: 'blue', status: 0, label: 'æ–°ç¯€é»', date_single: today, date_start: today, date_end: today, content: 'è«‹è¼¸å…¥å…§å®¹...' };
            container.appendChild(createNodeElement(newItem));
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            autoSave();
        });

        /* --- å­˜æª”ç³»çµ± --- */
        function gatherData() {
            const items = [];
            container.querySelectorAll('.timeline-item').forEach(el => {
                const card = el.querySelector('.card');
                const statusEl = el.querySelector('.status-dot');
                let status = 0;
                ['status-1','status-2','status-3'].forEach((c,i) => { if(statusEl.classList.contains(c)) status = i+1; });
                
                let pos = 'auto';
                if(el.classList.contains('force-left')) pos = 'left';
                if(el.classList.contains('force-right')) pos = 'right';

                items.push({
                    pos: pos,
                    mode: el.classList.contains('range-mode') ? 'range' : 'normal',
                    color: card.getAttribute('data-color'),
                    status: status,
                    label: el.querySelector('.label-input').value, // å­˜æ¨™é¡Œ
                    date_single: el.querySelector('.single-date').value, // å­˜æ—¥æœŸ value
                    date_start: el.querySelector('.date-start').value,
                    date_end: el.querySelector('.date-end').value,
                    content: el.querySelector('.content').innerText
                });
            });
            return items;
        }

        function autoSave() {
            localStorage.setItem('timeline_v9_data', JSON.stringify(gatherData()));
            localStorage.setItem('timeline_v9_notes', stickyNotes.value);
            saveStatus.innerText = 'å·²å„²å­˜';
            setTimeout(() => saveStatus.innerText = '', 2000);
        }

        window.downloadJSON = function() {
            const data = { timeline: gatherData(), notes: stickyNotes.value, version: 'v9' };
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'}));
            a.download = `timeline_v9_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        window.loadJSON = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(json.timeline) { renderFromData(json.timeline); stickyNotes.value = json.notes || ''; autoSave(); alert('è®€å–æˆåŠŸï¼'); }
                } catch(err) { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
            };
            reader.readAsText(file);
        }

        stickyNotes.addEventListener('input', autoSave);
        init();
    </script>
</body>
</html>
