<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±å‘Šç¥å™¨ V11ï¼šæˆªåœ–èˆ‡æ–‡æœ¬åŒ¯å‡ºç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f3f4f6;
            --text: #1f2937;
            --status-gray: #9ca3af;
            --status-yellow: #f59e0b;
            --status-green: #10b981;
            --status-red: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            position: relative; 
            min-height: 100vh;
        }

        /* --- å·¥å…·åˆ— --- */
        .toolbar {
            position: fixed; top: 0; left: 0; right: 0;
            background: #1e293b; color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .tool-title { font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .save-status { font-size: 0.8rem; color: #94a3b8; margin-left: 10px; }
        .tool-btn-group { display: flex; gap: 10px; }
        
        .tool-btn {
            background: #334155; border: 1px solid #475569; color: white;
            padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .tool-btn:hover { background: #475569; }
        .tool-btn.highlight { background: #7c3aed; border-color: #6d28d9; }
        .tool-btn.highlight:hover { background: #6d28d9; }
        .tool-btn.sticky-btn { background: #f59e0b; border-color: #d97706; color: white; }
        .tool-btn.sticky-btn:hover { background: #d97706; }
        /* æˆªåœ–æŒ‰éˆ•å°ˆç”¨è‰² */
        .tool-btn.camera-btn { background: #059669; border-color: #047857; }
        .tool-btn.camera-btn:hover { background: #047857; }

        /* --- ä¸»å€åŸŸ --- */
        .main-area {
            max-width: 900px; margin: 60px auto 0 auto;
            padding: 40px 20px;
            min-height: calc(100vh - 100px);
            background: var(--bg); /* æˆªåœ–æ™‚éœ€è¦èƒŒæ™¯è‰² */
        }

        .timeline { position: relative; padding: 20px 0; }
        .timeline::before {
            content: ''; position: absolute; top: 10px; bottom: 10px; left: 50%;
            width: 4px; background: #e5e7eb; transform: translateX(-50%);
            border-radius: 2px; z-index: 0;
        }

        .timeline-item {
            position: relative; margin-bottom: 30px; width: 100%;
            display: flex; justify-content: center; transition: all 0.5s ease;
        }
        .timeline-item .card { width: 45%; transition: margin 0.3s; }
        .timeline-item:nth-child(odd) .card { margin-right: 50%; border-right: 4px solid transparent; }
        .timeline-item:nth-child(even) .card { margin-left: 50%; border-left: 4px solid transparent; }
        
        .timeline-item.force-left .card { margin-right: 50% !important; margin-left: 0 !important; border-right: 4px solid transparent; border-left: none; }
        .timeline-item.force-right .card { margin-left: 50% !important; margin-right: 0 !important; border-left: 4px solid transparent; border-right: none; }

        .card {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative; z-index: 10; border-top: 5px solid var(--primary);
        }
        
        .card[data-color="blue"] { border-top-color: #4f46e5; }
        .card[data-color="green"] { border-top-color: #10b981; background: #f0fdf4; }
        .card[data-color="red"] { border-top-color: #ef4444; background: #fef2f2; }
        .card[data-color="yellow"] { border-top-color: #f59e0b; background: #fffbeb; }
        .card[data-color="purple"] { border-top-color: #8b5cf6; background: #f5f3ff; }

        .status-dot {
            position: absolute; top: 15px; left: 15px; width: 12px; height: 12px;
            border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);
        }
        .status-0 { background: var(--status-gray); }
        .status-1 { background: var(--status-yellow); }
        .status-2 { background: var(--status-green); }
        .status-3 { background: var(--status-red); }

        .card-body { margin-top: 15px; }
        .header-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }

        .date-input {
            border: 1px solid #cbd5e1; background: #f8fafc; padding: 4px 8px; border-radius: 6px;
            font-family: inherit; font-size: 0.85rem; color: #334155; outline: none; cursor: pointer;
        }
        .label-input {
            border: none; border-bottom: 1px dashed #cbd5e1; padding: 4px 8px; font-weight: bold;
            color: var(--primary); font-size: 0.9rem; outline: none; flex: 1; min-width: 80px;
        }

        .range-container { display: none; align-items: center; gap: 5px; font-size: 0.85rem; color: #555; }
        .timeline-item.range-mode .single-date { display: none; }
        .timeline-item.range-mode .range-container { display: flex; }

        .content { line-height: 1.6; color: #4b5563; outline: none; min-height: 1.5em; font-size: 0.95rem; }
        
        .dot {
            position: absolute; left: 50%; top: 25px; width: 14px; height: 14px; background: white;
            border: 4px solid #ccc; border-radius: 50%; transform: translateX(-50%); z-index: 20;
        }

        .controls {
            position: absolute; top: 5px; right: 5px; display: flex; gap: 3px;
            opacity: 0; transition: opacity 0.2s; background: rgba(255,255,255,0.9); padding: 3px; border-radius: 4px;
        }
        /* æˆªåœ–æ¨¡å¼ä¸‹éš±è—æŒ‰éˆ• */
        .card:hover .controls { opacity: 1; }
        body.screenshot-mode .controls, 
        body.screenshot-mode .toolbar, 
        body.screenshot-mode .add-main,
        body.screenshot-mode .note-header { display: none !important; }

        .btn-icon {
            border: none; cursor: pointer; width: 24px; height: 24px;
            border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;
        }
        .bg-gray { background: #64748b; }
        .bg-blue { background: #3b82f6; }
        .bg-red { background: #ef4444; }

        .add-main {
            display: block; margin: 30px auto; padding: 12px 30px;
            background: var(--primary); color: white; border-radius: 30px;
            font-size: 1rem; border: none; cursor: pointer;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }

        /* ä¾¿åˆ©è²¼ */
        .sticky-note {
            position: absolute; width: 200px; min-height: 150px; padding: 0;
            border-radius: 2px 2px 10px 2px; box-shadow: 3px 3px 10px rgba(0,0,0,0.2);
            z-index: 100; display: flex; flex-direction: column;
            border: 1px solid rgba(0,0,0,0.1); transform: rotate(-1deg);
            transition: transform 0.1s;
        }
        .sticky-note:hover { z-index: 110; }
        .sticky-note.dragging { opacity: 0.8; cursor: grabbing; z-index: 1000; }

        .note-header {
            height: 24px; background: rgba(0,0,0,0.05); cursor: grab;
            display: flex; justify-content: flex-end; align-items: center; padding: 0 5px;
        }
        .note-close { cursor: pointer; font-size: 14px; color: #666; width: 20px; text-align: center; }
        .note-content {
            flex: 1; width: 100%; border: none; background: transparent; resize: none;
            padding: 10px; font-family: 'Comic Sans MS', sans-serif; font-size: 0.95rem; outline: none;
        }
        .note-yellow { background: #fef08a; }
        .note-pink { background: #fbcfe8; }
        .note-blue { background: #bae6fd; }
        .note-green { background: #bbf7d0; }

    </style>
</head>
<body>

    <div class="toolbar">
        <div class="tool-title">
            ğŸ§  æ€ç·’ç®¡ç† V11
            <span class="save-status" id="saveStatus"></span>
        </div>
        <div class="tool-btn-group">
            <button class="tool-btn sticky-btn" onclick="addStickyNote()">ğŸ“ +ä¾¿åˆ©è²¼</button>
            <button class="tool-btn highlight" onclick="sortByDate()">ğŸ“… æ’åº</button>
            <button class="tool-btn" onclick="copyMarkdown()">ğŸ“‹ è¤‡è£½æ–‡å­—</button>
            <button class="tool-btn camera-btn" onclick="takeScreenshot()">ğŸ“¸ æˆªåœ–ä¸‹è¼‰</button>
            
            <button class="tool-btn" onclick="downloadJSON()" style="font-size:0.8rem; opacity:0.7">ğŸ“¥</button>
            <button class="tool-btn" onclick="document.getElementById('fileInput').click()" style="font-size:0.8rem; opacity:0.7">ğŸ“¤</button>
            <input type="file" id="fileInput" hidden onchange="loadJSON(this)">
        </div>
    </div>

    <div class="main-area">
        <div class="timeline" id="container"></div>
        <button class="add-main" id="mainAddBtn">ï¼‹ æ–°å¢ç¯€é»</button>
    </div>

    <script>
        const container = document.getElementById('container');
        const saveStatus = document.getElementById('saveStatus');

        // é è¨­è³‡æ–™
        const defaultData = [
            { id: 1, pos: 'left', mode: 'normal', color: 'blue', status: 0, label: 'åŒ¯å‡ºåŠŸèƒ½', date_single: '2025-01-01', date_start: '', date_end: '', content: 'é»æ“Šä¸Šæ–¹çš„ã€ŒğŸ“¸ æˆªåœ–ä¸‹è¼‰ã€ï¼Œæœƒå¹«ä½ æŠŠæ•´å€‹ç•«é¢ï¼ˆåŒ…å«é•·é•·çš„æ™‚é–“è»¸å’Œä¾¿åˆ©è²¼ï¼‰æ‹æˆä¸€å¼µåœ–ã€‚' },
            { id: 2, pos: 'right', mode: 'range', color: 'green', status: 0, label: 'æ–‡å­—å‚™ä»½', date_single: '', date_start: '2025-02-01', date_end: '2025-04-30', content: 'é»æ“Šã€ŒğŸ“‹ è¤‡è£½æ–‡å­—ã€ï¼Œå¯ä»¥ç›´æ¥æŠŠé€™è£¡çš„å…§å®¹è®Šæˆ Markdown è²¼åˆ°ç­†è¨˜è»Ÿé«”ã€‚' }
        ];

        function init() {
            const savedData = localStorage.getItem('timeline_v11_data');
            const savedNotes = localStorage.getItem('timeline_v11_notes');
            if (savedData) renderFromData(JSON.parse(savedData));
            else renderFromData(defaultData);
            if (savedNotes) renderNotes(JSON.parse(savedNotes));
        }

        /* --- ğŸ“¸ æˆªåœ–åŠŸèƒ½ (ä½¿ç”¨ html2canvas) --- */
        function takeScreenshot() {
            // 1. é€²å…¥æˆªåœ–æ¨¡å¼ (éš±è— UI)
            document.body.classList.add('screenshot-mode');
            
            // 2. ç‚ºäº†è®“æˆªåœ–åŒ…å«æ‰€æœ‰æ²å‹•å…§å®¹ï¼Œæš«æ™‚èª¿æ•´æ¨£å¼
            window.scrollTo(0, 0);

            saveStatus.innerText = 'æˆªåœ–ç”Ÿæˆä¸­...';

            html2canvas(document.body, {
                backgroundColor: '#f3f4f6', // èƒŒæ™¯è‰²
                scale: 2 // æé«˜è§£æåº¦ (2å€)
            }).then(canvas => {
                // 3. ä¸‹è¼‰åœ–ç‰‡
                const link = document.createElement('a');
                link.download = `timeline_snap_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();

                // 4. æ¢å¾©åŸç‹€
                document.body.classList.remove('screenshot-mode');
                saveStatus.innerText = 'æˆªåœ–å®Œæˆ';
                setTimeout(() => saveStatus.innerText = '', 2000);
            });
        }

        /* --- ğŸ“‹ è¤‡è£½ Markdown åŠŸèƒ½ --- */
        function copyMarkdown() {
            let md = "# æ™‚é–“è»¸å ±å‘Š\n\n";
            const items = gatherData();
            
            items.forEach(item => {
                let dateStr = item.mode === 'range' ? `${item.date_start} ~ ${item.date_end}` : item.date_single;
                let statusIcon = ['âšª', 'ğŸŸ¡', 'ğŸŸ¢', 'ğŸ”´'][item.status];
                
                md += `### ${statusIcon} ${item.label || 'ç„¡æ¨™é¡Œ'} (${dateStr})\n`;
                md += `- ${item.content}\n\n`;
            });

            // åŠ å…¥ä¾¿åˆ©è²¼
            const notes = gatherNotes();
            if(notes.length > 0) {
                md += "---\n## ğŸ“ éš¨æ‰‹ç­†è¨˜\n";
                notes.forEach(note => {
                    md += `> ${note.content.replace(/\n/g, '\n> ')}\n\n`;
                });
            }

            navigator.clipboard.writeText(md).then(() => {
                alert('å…§å®¹å·²è¤‡è£½ï¼\nç¾åœ¨ä½ å¯ä»¥å» Notion/Word/Line è²¼ä¸Šäº† (Ctrl+V)');
            });
        }

        /* --- åŸºæœ¬åŠŸèƒ½ (èˆ‡ V10 ç›¸åŒ) --- */
        function addStickyNote() {
            const colors = ['note-yellow', 'note-pink', 'note-blue', 'note-green'];
            createStickyElement({
                id: Date.now(),
                x: 20 + Math.random() * 200,
                y: 100 + window.scrollY + Math.random() * 100,
                color: colors[Math.floor(Math.random() * colors.length)],
                content: ''
            });
            autoSave();
        }

        function createStickyElement(note) {
            const div = document.createElement('div');
            div.className = `sticky-note ${note.color}`;
            div.style.left = note.x + 'px';
            div.style.top = note.y + 'px';
            div.setAttribute('id', 'note-' + note.id);
            div.innerHTML = `
                <div class="note-header" onmousedown="dragMouseDown(event, this.parentNode)">
                    <span class="note-close" onclick="deleteSticky(this)">Ã—</span>
                </div>
                <textarea class="note-content" oninput="autoSave()" placeholder="å¯«é»ä»€éº¼...">${note.content}</textarea>`;
            document.body.appendChild(div);
        }

        function deleteSticky(btn) { if(confirm('åˆªé™¤?')) { btn.closest('.sticky-note').remove(); autoSave(); } }

        let pos1=0,pos2=0,pos3=0,pos4=0;
        window.dragMouseDown = function(e, elmnt) {
            e = e || window.event; e.preventDefault();
            pos3 = e.clientX; pos4 = e.clientY; elmnt.classList.add('dragging');
            document.onmouseup = function() { closeDragElement(elmnt); };
            document.onmousemove = function(e) { elementDrag(e, elmnt); };
        }
        function elementDrag(e, elmnt) {
            e = e || window.event; e.preventDefault();
            pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
            pos3 = e.clientX; pos4 = e.clientY;
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }
        function closeDragElement(elmnt) { document.onmouseup = null; document.onmousemove = null; elmnt.classList.remove('dragging'); autoSave(); }

        function renderFromData(data) { container.innerHTML = ''; data.forEach(item => container.appendChild(createNodeElement(item))); }
        function renderNotes(notes) { document.querySelectorAll('.sticky-note').forEach(el => el.remove()); notes.forEach(note => createStickyElement(note)); }

        function createNodeElement(item) {
            const div = document.createElement('div');
            div.className = `timeline-item ${item.pos === 'left' ? 'force-left' : item.pos === 'right' ? 'force-right' : ''} ${item.mode === 'range' ? 'range-mode' : ''}`;
            div.innerHTML = `
                <div class="dot"></div>
                <div class="card" data-color="${item.color}">
                    <div class="status-dot status-${item.status}" onclick="cycleStatus(this)"></div>
                    <div class="controls">
                        <button class="btn-icon bg-gray" onclick="changeColor(this)">ğŸ¨</button>
                        <button class="btn-icon bg-gray" onclick="moveNode(this,'up')">â¬†ï¸</button>
                        <button class="btn-icon bg-gray" onclick="moveNode(this,'down')">â¬‡ï¸</button>
                        <button class="btn-icon bg-gray" onclick="togglePos(this,'left')">â¬…ï¸</button>
                        <button class="btn-icon bg-gray" onclick="togglePos(this,'right')">â¡ï¸</button>
                        <button class="btn-icon bg-blue" onclick="toggleRange(this)">â†”ï¸</button>
                        <button class="btn-icon bg-red" onclick="deleteNode(this)">Ã—</button>
                    </div>
                    <div class="card-body">
                        <div class="header-row">
                            <input type="date" class="date-input single-date" value="${item.date_single}" onchange="autoSave()">
                            <div class="range-container">
                                <input type="date" class="date-input date-start" value="${item.date_start}" onchange="autoSave()">âœ<input type="date" class="date-input date-end" value="${item.date_end}" onchange="autoSave()">
                            </div>
                            <input type="text" class="label-input" value="${item.label}" placeholder="æ¨™é¡Œ" oninput="autoSave()">
                        </div>
                        <div class="content" contenteditable="true" oninput="autoSave()">${item.content}</div>
                    </div>
                </div>`;
            return div;
        }

        window.sortByDate = function() {
            const items = Array.from(container.children);
            items.sort((a, b) => {
                const getDateVal = (el) => {
                    let val = el.classList.contains('range-mode') ? el.querySelector('.date-start').value : el.querySelector('.single-date').value;
                    return val ? new Date(val).getTime() : 9999999999999;
                };
                return getDateVal(a) - getDateVal(b);
            });
            items.forEach(item => container.appendChild(item));
            autoSave();
            alert('å·²æ’åºï¼');
        }

        window.cycleStatus = function(el) {
            const classes = ['status-0', 'status-1', 'status-2', 'status-3'];
            let cur = classes.find(c => el.classList.contains(c)) || 'status-0';
            el.className = `status-dot ${classes[(classes.indexOf(cur) + 1) % classes.length]}`; autoSave();
        }
        window.changeColor = function(btn) { const card = btn.closest('.card'); const colors=['blue','green','yellow','red','purple']; const cur = card.getAttribute('data-color')||'blue'; card.setAttribute('data-color', colors[(colors.indexOf(cur)+1)%colors.length]); autoSave(); }
        window.togglePos = function(btn, dir) { const item = btn.closest('.timeline-item'); if(dir==='left'){item.classList.add('force-left');item.classList.remove('force-right');}else{item.classList.add('force-right');item.classList.remove('force-left');} autoSave(); }
        window.toggleRange = function(btn) { btn.closest('.timeline-item').classList.toggle('range-mode'); autoSave(); }
        window.deleteNode = function(btn) { if(confirm('åˆªé™¤?')) { btn.closest('.timeline-item').remove(); autoSave(); } }
        window.moveNode = function(btn, dir) { const item = btn.closest('.timeline-item'); if(dir==='up'&&item.previousElementSibling)item.parentNode.insertBefore(item,item.previousElementSibling); else if(dir==='down'&&item.nextElementSibling)item.parentNode.insertBefore(item,item.nextElementSibling.nextSibling); autoSave(); }
        document.getElementById('mainAddBtn').addEventListener('click', () => { const today=new Date().toISOString().split('T')[0]; container.appendChild(createNodeElement({id:Date.now(),pos:'auto',mode:'normal',color:'blue',status:0,label:'',date_single:today,date_start:today,date_end:today,content:'å…§å®¹...'})); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); autoSave(); });

        function gatherData() {
            const items = [];
            container.querySelectorAll('.timeline-item').forEach(el => {
                const card = el.querySelector('.card');
                const statusEl = el.querySelector('.status-dot');
                let status = 0; ['status-1','status-2','status-3'].forEach((c,i) => { if(statusEl.classList.contains(c)) status = i+1; });
                let pos = 'auto'; if(el.classList.contains('force-left')) pos='left'; if(el.classList.contains('force-right')) pos='right';
                items.push({ pos, mode: el.classList.contains('range-mode')?'range':'normal', color: card.getAttribute('data-color'), status, label: el.querySelector('.label-input').value, date_single: el.querySelector('.single-date').value, date_start: el.querySelector('.date-start').value, date_end: el.querySelector('.date-end').value, content: el.querySelector('.content').innerText });
            }); return items;
        }
        function gatherNotes() {
            const notes = []; document.querySelectorAll('.sticky-note').forEach(el => {
                let color = 'note-yellow'; if(el.classList.contains('note-pink')) color='note-pink'; if(el.classList.contains('note-blue')) color='note-blue'; if(el.classList.contains('note-green')) color='note-green';
                notes.push({ id: el.id.replace('note-', ''), x: el.offsetLeft, y: el.offsetTop, color, content: el.querySelector('.note-content').value });
            }); return notes;
        }
        function autoSave() { localStorage.setItem('timeline_v11_data', JSON.stringify(gatherData())); localStorage.setItem('timeline_v11_notes', JSON.stringify(gatherNotes())); saveStatus.innerText = 'å·²å„²å­˜'; setTimeout(() => saveStatus.innerText = '', 2000); }
        window.downloadJSON = function() { const data = { timeline: gatherData(), notes: gatherNotes(), version: 'v11' }; const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type:'application/json'})); a.download = `timeline_v11_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
        window.loadJSON = function(input) { const file = input.files[0]; if(!file)return; const reader = new FileReader(); reader.onload = function(e) { try { const json = JSON.parse(e.target.result); if(json.timeline) { renderFromData(json.timeline); if(json.notes) renderNotes(json.notes); autoSave(); alert('è®€å–æˆåŠŸï¼'); } } catch(err){alert('æ ¼å¼éŒ¯');} }; reader.readAsText(file); }

        init();
    </script>
</body>
</html>
