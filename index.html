<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å ±å‘Šç¥å™¨ V44ï¼šæ’ç‰ˆä¿®å¾©ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f3f4f6;
            --text: #1f2937;
            --font-stack: "Microsoft JhengHei", "Heiti TC", sans-serif; 
        }

        body {
            font-family: var(--font-stack);
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            position: relative; 
            min-height: 100vh;
            transition: background-color 0.3s;
        }

        /* --- é ‚éƒ¨å·¥å…·åˆ— --- */
        .toolbar {
            position: fixed; top: 0; left: 0; right: 0;
            background: #1e293b; color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            height: 50px;
        }

        .tool-left { display: flex; align-items: center; gap: 15px; flex-shrink: 0; }
        .tool-title { font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .save-status { font-size: 0.8rem; color: #94a3b8; }
        
        .search-box { position: relative; display: flex; align-items: center; gap: 10px; }
        .search-input {
            background: #334155; border: 1px solid #475569; color: white;
            padding: 6px 10px 6px 30px; border-radius: 20px; font-size: 0.9rem;
            width: 120px; transition: width 0.3s; outline: none;
        }
        .search-input:focus { width: 180px; border-color: #3b82f6; }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: 0.6; font-size: 12px; }
        
        .tool-btn-group { display: flex; gap: 10px; overflow-x: auto; padding-right: 10px; align-items: center; height: 100%; }
        .tool-btn-group::-webkit-scrollbar { display: none; }
        
        .tool-btn {
            background: transparent; 
            border: 1px solid #475569; 
            color: #e2e8f0; 
            padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; gap: 6px; transition: 0.2s; white-space: nowrap; flex-shrink: 0;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.1); border-color: white; color: white; }
        
        .tool-btn.highlight { border-color: #a78bfa; color: #a78bfa; }
        .tool-btn.camera-btn { border-color: #34d399; color: #34d399; }
        .tool-btn.danger-btn { border-color: #f87171; color: #f87171; }
        .tool-btn.ai-btn { border-color: #c084fc; color: #c084fc; }
        .tool-btn.filter-btn { border-color: #d97706; color: #fbbf24; }
        .tool-btn.google-btn { border-color: #60a5fa; color: #60a5fa; } 
        .tool-btn.keep-btn { border-color: #facc15; color: #facc15; } 

        #ai-toolbar { display: none; }
        body.ai-selecting #normal-toolbar { display: none; }
        body.ai-selecting #ai-toolbar { display: flex; }
        
        /* å°ˆæ¡ˆéæ¿¾åˆ— */
        #project-bar {
            position: fixed; top: 70px; left: 0; right: 0;
            background: #f8fafc; border-bottom: 1px solid #e2e8f0;
            padding: 10px 20px; z-index: 1950;
            display: none; flex-wrap: wrap; gap: 10px; 
            max-height: 120px; overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); align-items: center;
        }
        #project-bar.show { display: flex; }
        
        .proj-badge {
            font-size: 0.85rem; padding: 4px 12px; border-radius: 20px; cursor: pointer;
            background: white; border: 1px solid #cbd5e1; color: #64748b; transition: 0.2s;
            display: flex; align-items: center; gap: 5px; user-select: none;
        }
        .proj-badge:hover { background: #f1f5f9; border-color: #94a3b8; }
        .proj-badge.active { background: #dbeafe; border-color: #3b82f6; color: #2563eb; font-weight: bold; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2); }
        .proj-hint { font-size: 0.8rem; color: #94a3b8; margin-right: 10px; }
        
        .rename-btn {
            font-size: 0.8rem; padding: 4px 10px; background: #8b5cf6; color: white;
            border-radius: 4px; cursor: pointer; border: none; display: flex; align-items: center; gap: 4px;
        }

        /* å·¦å´åœ–å½¢å·¥å…·ç®± */
        .toolbox-container {
            position: fixed; top: 220px; left: 20px; z-index: 1800;
            transition: transform 0.3s ease;
        }
        .toolbox-container.closed { transform: translateX(-130%); }

        .toolbox {
            width: 80px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 8px; padding: 15px 5px;
            align-items: center; position: relative;
        }

        .toolbox-toggle-btn {
            position: absolute; top: 0; right: -24px;
            width: 24px; height: 40px;
            background: #3b82f6; color: white;
            border-top-right-radius: 8px; border-bottom-right-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }

        .toolbox-header { font-size: 0.8rem; color: #64748b; font-weight:bold; margin: 5px 0 2px 0; border-bottom: 1px solid #eee; width: 100%; text-align: center; padding-bottom: 2px;}
        .tool-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 60px; padding: 5px 0; cursor: pointer; border-radius: 6px; transition: 0.2s;
            border: 1px solid transparent;
        }
        .tool-item:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .tool-icon { font-size: 1.4rem; line-height: 1; margin-bottom: 2px; }
        .tool-text { font-size: 0.75rem; color: #475569; }

        /* ä¸»å€åŸŸ */
        .main-area {
            max-width: 900px; margin: 80px auto 0 auto; padding: 40px 20px;
            min-height: calc(100vh - 100px); background: var(--bg);
            transition: margin-top 0.3s;
        }
        body.has-proj-bar .main-area { margin-top: 180px; }

        /* Timeline & Card */
        .timeline { position: relative; padding: 20px 0; }
        .timeline::before {
            content: ''; position: absolute; top: 10px; bottom: 10px; left: 50%;
            width: 4px; background: #e5e7eb; transform: translateX(-50%);
            border-radius: 2px; z-index: 0; transition: left 0.3s;
        }

        .timeline-item {
            position: relative; margin-bottom: 50px; /* ä¿æŒèˆ’é©é–“è· */
            width: 100%;
            display: flex; justify-content: center; transition: all 0.5s ease;
        }
        .timeline-item.hidden-by-filter { display: none !important; } 

        .timeline-item .card { width: 45%; transition: margin 0.3s, width 0.3s; }
        .timeline-item:nth-child(odd) .card { margin-right: 50%; border-right: 4px solid transparent; }
        .timeline-item:nth-child(even) .card { margin-left: 50%; border-left: 4px solid transparent; }
        .timeline-item.force-left .card { margin-right: 50% !important; margin-left: 0 !important; border-right: 4px solid transparent; border-left: none; }
        .timeline-item.force-right .card { margin-left: 50% !important; margin-right: 0 !important; border-left: 4px solid transparent; border-right: none; }

        /* V44: å¡ç‰‡çµæ§‹ Flexbox ä¿®æ­£ */
        .card {
            display: flex; flex-direction: column; 
            background: white; border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative; z-index: 10; 
            padding: 0; 
            overflow: hidden;
            border-top: 5px solid var(--primary);
            min-height: 180px; /* ç¢ºä¿é«˜åº¦è¶³å¤  */
        }
        
        .card.memo-mode {
            border-top-style: dashed; 
            background-color: #fcfcfc;
        }
        
        .card[data-color="blue"] { border-top-color: #4f46e5; }
        .card[data-color="green"] { border-top-color: #10b981; background: #f0fdf4; }
        .card[data-color="red"] { border-top-color: #ef4444; background: #fef2f2; }
        .card[data-color="yellow"] { border-top-color: #f59e0b; background: #fffbeb; }
        
        .card.memo-mode[data-color="green"] { background: #f7fee7; }
        .card.memo-mode[data-color="red"] { background: #fff1f2; }
        .card.memo-mode[data-color="yellow"] { background: #fffbeb; }

        /* é ‚éƒ¨å€åŸŸ */
        .card-top-area {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 50px 5px 20px; /* é ç•™å³å´çµ¦ Side Tools */
            border-bottom: 1px dashed #e2e8f0;
            flex-shrink: 0; 
            min-height: 40px; /* V44: é˜²æ­¢å‚™å¿˜æ¨¡å¼å¡Œé™· */
        }
        .card-top-left { display: flex; align-items: center; gap: 8px; flex: 1; flex-wrap: wrap; }
        .card-top-right { display: flex; gap: 3px; margin-left: 10px; flex-shrink: 0; flex-wrap: nowrap; opacity: 1; }

        /* å…§å®¹å€åŸŸ */
        .card-body {
            padding: 15px 60px 20px 25px; 
            flex-grow: 1; /* é‡è¦ï¼šæ’é–‹ä¸­é–“å€åŸŸ */
        }

        /* åº•éƒ¨æ¨™ç±¤ (Flex Item) */
        .project-footer {
            width: 100%;
            height: 32px; 
            display: flex; align-items: center; justify-content: flex-end;
            padding: 0 15px;
            background: #cbd5e1;
            transition: background-color 0.3s;
            margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
        }
        .card[data-color="blue"] .project-footer { background: #4f46e5; }
        .card[data-color="green"] .project-footer { background: #10b981; }
        .card[data-color="red"] .project-footer { background: #ef4444; }
        .card[data-color="yellow"] .project-footer { background: #f59e0b; }
        .card.memo-mode .project-footer { opacity: 0.7; }

        .footer-project-input {
            background: transparent; border: none; 
            color: white; font-weight: bold; font-size: 0.9rem;
            text-align: right; width: 100%; outline: none;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .footer-project-input::placeholder { color: rgba(255,255,255,0.7); }

        /* å´é‚Šå‚ç›´å·¥å…·åˆ— */
        .card-side-tools {
            position: absolute; right: 8px; top: 60px; bottom: 40px; /* é¿é–‹é ‚åº• */
            display: flex; flex-direction: column; gap: 6px;
            align-items: center; justify-content: flex-start;
            width: 30px; 
            padding-left: 5px; 
            border-left: 1px dashed #f1f5f9;
            opacity: 1; 
            z-index: 20;
        }

        .status-dot {
            width: 14px; height: 14px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .status-0 { background: #9ca3af; } .status-1 { background: #f59e0b; } .status-2 { background: #10b981; } .status-3 { background: #ef4444; }

        .btn-icon { 
            border: 1px solid #334155; background: transparent; color: #334155; 
            cursor: pointer; width: 28px; height: 28px; border-radius: 4px; 
            display: flex; align-items: center; justify-content: center; font-size: 14px;
            flex-shrink: 0; transition: 0.2s;
        }
        .btn-icon:hover { background: #f1f5f9; border-color: #1e293b; color: #1e293b; }
        .side-btn { width: 26px; height: 26px; font-size: 12px; }

        .mode-toggle-btn {
            font-size: 12px; border: 1px solid #94a3b8; border-radius: 4px; 
            padding: 2px 6px; cursor: pointer; background: #f1f5f9; color: #64748b;
        }
        .mode-toggle-btn:hover { background: #e2e8f0; }

        .select-chk { width: 20px; height: 20px; margin-right: 8px; cursor: pointer; accent-color: #8b5cf6; transform: scale(1.2); display: none; }
        body.ai-selecting .select-chk { display: inline-block; }

        .date-input {
            border: 1px solid #cbd5e1; background: #f8fafc; padding: 4px 8px; border-radius: 6px;
            font-family: inherit; font-size: 0.85rem; color: #334155; outline: none; cursor: pointer; width: 115px;
        }
        .card.memo-mode .date-input, .card.memo-mode .today-btn, .card.memo-mode .range-container { display: none !important; }

        .today-btn {
            background: #e0e7ff; color: #4338ca; border: none; border-radius: 4px;
            padding: 4px 8px; font-size: 0.75rem; cursor: pointer; font-weight: bold;
        }
        .label-input {
            border: none; border-bottom: 1px dashed #cbd5e1; padding: 4px 8px; font-weight: bold;
            color: var(--primary); font-size: 1rem; outline: none; flex: 1; min-width: 120px;
        }
        .range-container { display: none; align-items: center; gap: 5px; font-size: 0.85rem; color: #555; flex-wrap: wrap;}
        .timeline-item.range-mode .single-date { display: none; }
        .timeline-item.range-mode .range-container { display: flex; }

        .content { 
            line-height: 1.6; color: #4b5563; outline: none; min-height: 1.5em; font-size: 0.95rem; 
            white-space: pre-wrap; margin-bottom: 10px;
        }
        .content img { max-width: 100%; height: auto; border-radius: 4px; margin: 5px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: block; }
        .todo-box { display: inline-block; width: 1.2em; text-align: center; cursor: pointer; color: #4f46e5; }
        .highlight-text { background-color: #fef08a; padding: 0 2px; border-radius: 2px; }

        .dot {
            position: absolute; left: 50%; top: 25px; width: 14px; height: 14px; background: white;
            border: 4px solid #ccc; border-radius: 50%; transform: translateX(-50%); z-index: 20; transition: left 0.3s;
        }

        /* V44: æ–°å¢ç¯€é»æŒ‰éˆ•ç¾åŒ– (è™›ç·šé¢¨æ ¼) */
        .add-main {
            display: block; margin: 50px auto; padding: 12px 30px;
            background: transparent; 
            color: #64748b;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
            transition: 0.2s; width: 100%; max-width: 300px;
        }
        .add-main:hover { border-color: #94a3b8; color: #334155; background: #f8fafc; }

        /* --- Gantt View --- */
        #gantt-view { display: none; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow-x: auto; margin-bottom: 30px; border: 1px solid #e2e8f0; }
        .gantt-container { position: relative; min-width: 800px; padding-top: 40px; padding-bottom: 20px; }
        .gantt-axis-labels { position: absolute; top: 0; left: 160px; right: 0; height: 30px; border-bottom: 1px solid #e2e8f0; }
        .gantt-axis-mark { position: absolute; top: 0; font-size: 0.75rem; color: #64748b; border-left: 1px dashed #e2e8f0; height: 100vh; padding-left: 4px; pointer-events: none; }
        .gantt-row { position: relative; height: 40px; margin-bottom: 8px; display: flex; align-items: center; border-bottom: 1px dashed #f1f5f9; }
        .gantt-label-col { width: 150px; flex-shrink: 0; font-size: 0.85rem; font-weight: bold; color: #334155; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; text-align: right; border-right: 2px solid #e2e8f0; margin-right: 10px; line-height: 40px; }
        .gantt-bar-area { flex-grow: 1; position: relative; height: 100%; }
        .gantt-bar { position: absolute; top: 8px; height: 24px; border-radius: 4px; font-size: 0.75rem; color: white; white-space: nowrap; display: flex; align-items: center; padding: 0 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.15); cursor: help; transition: all 0.2s; }
        .gantt-bar[data-color="blue"] { background: #4f46e5; } .gantt-bar[data-color="green"] { background: #10b981; } .gantt-bar[data-color="red"] { background: #ef4444; } .gantt-bar[data-color="yellow"] { background: #f59e0b; color: #333; }

        #exit-pres-btn {
            display: none; position: fixed; top: 20px; right: 20px; z-index: 3000;
            padding: 10px 20px; background: #ef4444; color: white;
            border: none; border-radius: 30px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-weight: bold; font-size: 1rem;
        }

        body.presentation-mode { background-color: #ffffff; padding: 0; }
        body.presentation-mode #exit-pres-btn { display: block; }
        body.presentation-mode .toolbar, body.presentation-mode .toolbox-container, body.presentation-mode .add-main, body.presentation-mode .sticker-del, body.presentation-mode .today-btn, body.presentation-mode .note-header, body.presentation-mode .select-chk, body.presentation-mode .project-input::placeholder, body.presentation-mode #project-bar,
        body.presentation-mode .card-top-right, body.presentation-mode .card-side-tools,
        body.presentation-mode .mode-toggle-btn 
        { display: none !important; }

        body.presentation-mode .project-footer { height: 20px; padding: 0 10px; }
        body.presentation-mode .footer-project-input { pointer-events: none; font-size: 0.8rem; }
        body.presentation-mode .main-area { margin-top: 0 !important; padding-top: 20px; max-width: 1200px; }
        body.presentation-mode .card { box-shadow: none; border: 1px solid #e5e7eb; border-top: none; padding-bottom: 0; padding-right: 20px; } 
        body.presentation-mode .card.memo-mode { border-top: 1px dashed #cbd5e1; }
        body.presentation-mode .date-input, body.presentation-mode .label-input { background: transparent; border: none; font-size: 1.1rem; }
        body.presentation-mode .content { font-size: 1.1rem; }
        body.presentation-mode .sticky-note { box-shadow: 2px 2px 5px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }

        @media screen and (max-width: 768px) {
            body { padding: 10px; }
            .main-area { margin-top: 50px; padding: 10px 0; }
            body.has-proj-bar .main-area { margin-top: 140px; }
            .toolbox-container { display: none !important; }
            .toolbar { padding: 10px; gap: 10px; }
            .tool-left { gap: 5px; }
            .tool-title span { display: none; }
            .search-input { width: 80px; padding-left: 25px; }
            .search-input:focus { width: 120px; }
            .search-icon { left: 8px; }
            .timeline::before { left: 20px; transform: none; }
            .dot { left: 20px; transform: none; margin-left: -7px; }
            .timeline-item { flex-direction: column; align-items: flex-end; width: 100%; margin-left: 0; }
            .timeline-item .card, .timeline-item:nth-child(odd) .card, .timeline-item:nth-child(even) .card, .timeline-item.force-left .card, .timeline-item.force-right .card {
                width: calc(100% - 50px) !important; margin: 0 0 20px 0 !important; border-left: none !important; border-right: none !important;
            }
            .header-row { align-items: flex-start; }
            .label-input { width: 100%; margin-top: 5px; }
            #gantt-view { padding: 10px; }
            .gantt-label-col { width: 100px; font-size: 0.75rem; }
        }

        @media print { 
            .toolbar, .toolbox-container, .card-top-right, .card-side-tools, .add-main, .note-header, .sticker-del, .today-btn, #exit-pres-btn, .select-chk, #project-bar, .mode-toggle-btn { display: none !important; } 
            .sticky-note, .sticker { box-shadow: none; border: 1px solid transparent; } 
        }
        body.screenshot-mode .toolbar, body.screenshot-mode .toolbox-container, body.screenshot-mode .card-top-right, body.screenshot-mode .card-side-tools, body.screenshot-mode .note-header, body.screenshot-mode .sticker-del, body.screenshot-mode .add-main, body.screenshot-mode .today-btn, body.screenshot-mode #exit-pres-btn, body.screenshot-mode .select-chk, body.screenshot-mode #project-bar, body.screenshot-mode .mode-toggle-btn { display: none !important; }

    </style>
</head>
<body>

    <div class="toolbar">
        <div class="tool-left">
            <div class="tool-title">
                ğŸ§  V44
                <span class="save-status" id="saveStatus"></span>
            </div>
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-input" placeholder="æœå°‹..." oninput="filterNodes(this.value)">
            </div>
        </div>
        
        <div class="tool-btn-group" id="normal-toolbar">
            <button class="tool-btn filter-btn" onclick="toggleProjectBar()" title="å±•é–‹å°ˆæ¡ˆéæ¿¾åˆ—">ğŸ“ å°ˆæ¡ˆ</button>
            <button class="tool-btn view-btn" onclick="toggleView()" id="viewBtn">ğŸ“Š ç”˜ç‰¹åœ–</button>
            <button class="tool-btn pres-btn" onclick="togglePresentation()" title="ç°¡å ±æ¨¡å¼">ğŸ“½ï¸ ç°¡å ±</button>
            <button class="tool-btn ai-btn" onclick="enterAIMode()" title="é€²å…¥é¸å–æ¨¡å¼ç”Ÿæˆ Prompt">ğŸ¤– AIè¼¸å‡º</button>
            <button class="tool-btn cal-btn" onclick="exportToCSV()">ğŸ“… CSV</button>
            <button class="tool-btn highlight" onclick="sortByDate()">ğŸ“… æ’åº</button>
            <button class="tool-btn danger-btn" onclick="clearAllImages()" title="åˆªé™¤åœ–ç‰‡">ğŸ§¹ æ¸…åœ–</button>
            <button class="tool-btn google-btn" onclick="openTasksWeb()" title="é–‹å•Ÿ Google Tasks">â˜‘ Tasks</button>
            <button class="tool-btn keep-btn" onclick="openKeepWeb()" title="é–‹å•Ÿ Google Keep">ğŸ’¡ Keep</button>
            <button class="tool-btn camera-btn" onclick="takeScreenshot()">ğŸ“¸ æˆªåœ–</button>
            <button class="tool-btn" onclick="downloadJSON()">ğŸ“¥ å‚™ä»½</button>
            <button class="tool-btn" onclick="document.getElementById('fileInput').click()">ğŸ“¤ è®€å–</button>
            <input type="file" id="fileInput" hidden onchange="loadJSON(this)">
        </div>

        <div class="tool-btn-group" id="ai-toolbar">
            <button class="tool-btn camera-btn" onclick="confirmAIOutput()">âœ… ç¢ºèªç”Ÿæˆ</button>
            <button class="tool-btn highlight" onclick="selectAllAI()">â˜‘ å…¨é¸</button>
            <button class="tool-btn danger-btn" onclick="exitAIMode()">âŒ å–æ¶ˆ</button>
        </div>
    </div>

    <div id="project-bar">
        <span class="proj-hint">è«‹é»é¸å°ˆæ¡ˆé€²è¡Œéæ¿¾ï¼š</span>
    </div>

    <button id="exit-pres-btn" onclick="togglePresentation()">âŒ é€€å‡ºç°¡å ±æ¨¡å¼ (ESC)</button>

    <div class="toolbox-container" id="toolboxContainer">
        <div class="toolbox">
            <div class="toolbox-header">ä¾¿åˆ©è²¼</div>
            <div class="tool-item" onclick="addStickyNote()"><span class="tool-icon">ğŸ“</span><span class="tool-text">æ–°å¢</span></div>
            <div class="toolbox-header">ç®­é ­</div>
            <div class="tool-item" onclick="addSticker('arrow-right')"><span class="tool-icon">â¡ï¸</span><span class="tool-text">å‘å³</span></div>
            <div class="tool-item" onclick="addSticker('arrow-down')"><span class="tool-icon">â¬‡ï¸</span><span class="tool-text">å‘ä¸‹</span></div>
            <div class="tool-item" onclick="addSticker('arrow-left')"><span class="tool-icon">â¬…ï¸</span><span class="tool-text">å‘å·¦</span></div>
            <div class="toolbox-header">é‡é»</div>
            <div class="tool-item" onclick="addSticker('circle-red')"><span class="tool-icon">â­•</span><span class="tool-text">ç´…åœˆ</span></div>
            <div class="tool-item" onclick="addSticker('rect-blue')"><span class="tool-icon">ğŸŸ¦</span><span class="tool-text">è—æ¡†</span></div>
        </div>
        <div class="toolbox-toggle-btn" onclick="toggleToolbox()" title="æ”¶ç´/å±•é–‹å·¥å…·ç®±">â—€</div>
    </div>

    <div class="main-area">
        <div class="timeline" id="container"></div>
        <div id="gantt-view">
            <div style="text-align:center; color:#888; margin-bottom:10px; font-size:0.8rem;">ğŸ’¡ å·¦å³æ»‘å‹•å¯æŸ¥çœ‹å®Œæ•´æ™‚é–“è»¸</div>
            <div class="gantt-container" id="ganttChart"></div>
        </div>
        <button class="add-main" id="mainAddBtn">ï¼‹ æ–°å¢ç¯€é»</button>
    </div>

    <script>
        const container = document.getElementById('container');
        const saveStatus = document.getElementById('saveStatus');
        const projectBar = document.getElementById('project-bar');
        
        let activeProjectFilters = new Set(); 

        function getTodayString() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        const defaultData = [
            { id: 1, pos: 'left', mode: 'normal', color: 'blue', status: 0, isMemo: false, project: 'å°ˆæ¡ˆA', label: 'V44æ’ç‰ˆä¿®æ­£', date_single: getTodayString(), date_start: '', date_end: '', content: '1. ä¿®æ­£äº†ã€Œæ–°å¢ç¯€é»ã€çš„ JS é‚è¼¯ï¼Œç¾åœ¨æ–°å¢çš„å¡ç‰‡æœƒä½¿ç”¨æ­£ç¢ºçš„ Flex ä½ˆå±€ï¼Œä¸æœƒå†è·‘ç‰ˆäº†ã€‚\n2. ã€Œæ–°å¢ç¯€é»ã€æŒ‰éˆ•æ¨£å¼å„ªåŒ–ï¼Œæ”¹ç‚ºè™›ç·šé»‘æ¡†ã€‚' },
            { id: 2, pos: 'right', mode: 'normal', color: 'green', status: 0, isMemo: true, project: 'å°ˆæ¡ˆA', label: 'å‚™å¿˜æ¨¡å¼', date_single: '', date_start: '', date_end: '', content: 'é€™æ˜¯ä¸€å¼µå‚™å¿˜å¡ï¼Œå·²åŠ ä¸Šæœ€å°é«˜åº¦é™åˆ¶ï¼Œæ¨™é¡Œèˆ‡å…§å®¹ä¸æœƒæ“ åœ¨ä¸€èµ·ã€‚' }
        ];

        function init() {
            const savedData = localStorage.getItem('timeline_v44_data'); 
            const savedNotes = localStorage.getItem('timeline_v44_notes');
            const savedStickers = localStorage.getItem('timeline_v44_stickers');

            if (savedData) renderFromData(JSON.parse(savedData));
            else renderFromData(defaultData);

            if (savedNotes) renderNotes(JSON.parse(savedNotes));
            if (savedStickers) renderStickers(JSON.parse(savedStickers));
            
            refreshProjectBar();
        }

        function insertBullet(btn) {
            const item = btn.closest('.timeline-item');
            const contentDiv = item.querySelector('.content');
            const newDiv = document.createElement('div');
            newDiv.innerHTML = '&nbsp;â€¢&nbsp;é …ç›®å…§å®¹';
            contentDiv.appendChild(newDiv);
            autoSave();
        }

        function addHighlight(btn) {
            document.execCommand('styleWithCSS', false, true);
            document.execCommand('hiliteColor', false, '#fef08a');
            autoSave();
        }

        function clearFormatting(btn) {
            document.execCommand('styleWithCSS', false, true);
            document.execCommand('removeFormat', false, null); 
            document.execCommand('hiliteColor', false, 'transparent'); 
            autoSave();
        }

        function copyForTasks(btn) {
            const item = btn.closest('.timeline-item');
            const projInput = item.querySelector('.footer-project-input'); 
            const project = projInput ? projInput.value.trim() : '';
            const title = item.querySelector('.label-input').value;
            const date = item.classList.contains('range-mode') 
                ? `${item.querySelector('.date-start').value} ~ ${item.querySelector('.date-end').value}` 
                : item.querySelector('.single-date').value;
            const content = item.querySelector('.content').innerText;
            
            let text = ``;
            if(project) text += `ã€${project}ã€‘`;
            text += `${title}\n`;
            if(!item.querySelector('.card').classList.contains('memo-mode')) { 
                text += `ğŸ“… ${date}\n`;
            }
            text += `----------------\n${content}`;
            
            navigator.clipboard.writeText(text).then(() => { 
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ…';
                setTimeout(() => btn.innerHTML = originalText, 1500);
            });
        }

        function openTasksWeb() {
            window.open('https://tasks.google.com/embed/list/~default', '_blank', 'width=400,height=600');
        }
        function openKeepWeb() {
            window.open('https://keep.google.com/', '_blank', 'width=600,height=800');
        }

        function enterAIMode() {
            document.body.classList.add('ai-selecting');
            alert('é€²å…¥ AI é¸å–æ¨¡å¼ï¼š\nè«‹å‹¾é¸æ‚¨æƒ³è¦åˆ†æçš„å¡ç‰‡ï¼Œç„¶å¾Œé»æ“Šä¸Šæ–¹ã€Œâœ… ç¢ºèªç”Ÿæˆã€ã€‚');
        }

        function exitAIMode() {
            document.body.classList.remove('ai-selecting');
            document.querySelectorAll('.select-chk').forEach(chk => chk.checked = false);
        }

        function selectAllAI() {
            document.querySelectorAll('.select-chk').forEach(chk => chk.checked = true);
        }

        function confirmAIOutput() {
            const timelineItems = document.querySelectorAll('.timeline-item');
            const selectedIndices = [];
            timelineItems.forEach((item, index) => {
                const checkbox = item.querySelector('.select-chk');
                if (checkbox && checkbox.checked) selectedIndices.push(index);
            });

            const allData = gatherData();
            let targetData = [];
            let promptIntro = "";

            if (selectedIndices.length > 0) {
                targetData = allData.filter((_, index) => selectedIndices.includes(index));
                promptIntro = `ã€æ³¨æ„ï¼šä½¿ç”¨è€…åƒ…é¸å–äº†éƒ¨åˆ†é‡é»å¡ç‰‡é€²è¡Œè¨è«–ã€‘`;
            } else {
                if(!confirm('æ‚¨æœªå‹¾é¸ä»»ä½•å¡ç‰‡ï¼Œæ˜¯å¦è¼¸å‡ºã€Œå…¨éƒ¨ã€å…§å®¹ï¼Ÿ')) return;
                targetData = allData;
                promptIntro = `ã€å®Œæ•´å°ˆæ¡ˆè³‡æ–™ã€‘`;
            }

            let prompt = `è«‹åˆ†æä»¥ä¸‹å°ˆæ¡ˆè³‡æ–™ï¼š\n${promptIntro}\næ—¥æœŸï¼š${getTodayString()}\n\n`;
            targetData.forEach((item, index) => {
                const dateStr = item.isMemo ? "(å‚™å¿˜/ç„¡æ—¥æœŸ)" : (item.mode === 'range' ? `${item.date_start}~${item.date_end}` : item.date_single);
                const status = ['æœªé–‹å§‹', 'é€²è¡Œä¸­', 'å·²å®Œæˆ', 'å»¶é²'][item.status] || 'æœªçŸ¥';
                const project = item.project ? `[${item.project}] ` : ''; 
                const cleanContent = item.content.replace(/<[^>]+>/g, '').replace(/\n+/g, ' ');
                prompt += `${index+1}. ${project}[${status}] ${dateStr} - ${item.label}: ${cleanContent}\n`;
            });
            prompt += `\nè«‹é‡å°ä»¥ä¸Šå…§å®¹é€²è¡Œå°ˆæ¡ˆé€²åº¦æ‘˜è¦ã€é¢¨éšªè©•ä¼°æˆ–ä¸‹ä¸€æ­¥å»ºè­°ã€‚`;

            navigator.clipboard.writeText(prompt).then(() => { 
                alert('âœ… AI Prompt å·²è¤‡è£½æˆåŠŸï¼');
                exitAIMode(); 
            });
        }

        function toggleProjectBar() {
            projectBar.classList.toggle('show');
            document.body.classList.toggle('has-proj-bar');
            refreshProjectBar();
        }

        function refreshProjectBar() {
            const allData = gatherData();
            const projects = new Set();
            allData.forEach(item => {
                if (item.project && item.project.trim() !== '') {
                    projects.add(item.project.trim());
                }
            });

            let html = '<span class="proj-hint">éæ¿¾ï¼š</span>';
            if (projects.size === 0) {
                html += '<span style="color:#999; font-size:0.8rem;">(ç„¡å°ˆæ¡ˆ)</span>';
            } else {
                projects.forEach(p => {
                    const isActive = activeProjectFilters.has(p) ? 'active' : '';
                    html += `<div class="proj-badge ${isActive}" onclick="toggleFilter('${p}')">${p}</div>`;
                });
                if(activeProjectFilters.size > 0) {
                    html += `<div class="proj-badge" style="color:#ef4444; border-color:#ef4444;" onclick="clearProjectFilters()">âœ• æ¸…é™¤</div>`;
                    if(activeProjectFilters.size === 1) {
                        const currentProj = activeProjectFilters.values().next().value;
                        html += `<button class="rename-btn" onclick="renameProject('${currentProj}')">âœï¸ æ”¹å</button>`;
                    }
                }
            }
            projectBar.innerHTML = html;
        }

        function toggleFilter(projectName) {
            if (activeProjectFilters.has(projectName)) {
                activeProjectFilters.delete(projectName);
            } else {
                activeProjectFilters.add(projectName);
            }
            refreshProjectBar();
            applyFilters();
        }

        function clearProjectFilters() {
            activeProjectFilters.clear();
            refreshProjectBar();
            applyFilters();
        }

        function renameProject(oldName) {
            const newName = prompt(`è«‹è¼¸å…¥ã€Œ${oldName}ã€çš„æ–°åç¨±ï¼š`, oldName);
            if(newName && newName !== oldName) {
                const items = document.querySelectorAll('.timeline-item');
                let count = 0;
                items.forEach(item => {
                    const input = item.querySelector('.footer-project-input'); 
                    if(input && input.value === oldName) {
                        input.value = newName;
                        count++;
                    }
                });
                autoSave();
                activeProjectFilters.delete(oldName);
                activeProjectFilters.add(newName);
                refreshProjectBar();
                applyFilters();
                alert(`å·²æ›´æ–° ${count} å€‹é …ç›®çš„å°ˆæ¡ˆåç¨±ï¼`);
            }
        }

        function applyFilters() {
            const keyword = document.querySelector('.search-input').value.toLowerCase();
            const items = document.querySelectorAll('.timeline-item');
            
            items.forEach(item => {
                const projInput = item.querySelector('.footer-project-input'); 
                const project = projInput ? projInput.value.trim() : '';
                const projectMatch = (activeProjectFilters.size === 0) || activeProjectFilters.has(project);
                const text = item.innerText.toLowerCase();
                const inputs = item.querySelectorAll('input');
                let textMatch = text.includes(keyword);
                inputs.forEach(inp => { if(inp.value.toLowerCase().includes(keyword)) textMatch = true; });

                if (projectMatch && textMatch) {
                    item.classList.remove('hidden-by-filter');
                } else {
                    item.classList.add('hidden-by-filter');
                }
            });
            if (currentView === 'gantt') renderGantt();
        }

        function filterNodes(val) { applyFilters(); }

        function toggleCardMode(btn) {
            const item = btn.closest('.timeline-item');
            const card = item.querySelector('.card');
            const isMemo = card.classList.toggle('memo-mode');
            
            if(isMemo) {
                btn.innerText = 'â™¾ï¸'; 
            } else {
                btn.innerText = 'ğŸ“…'; 
            }
            autoSave();
        }

        // V44: ç¢ºä¿ createNodeElement çš„ HTML çµæ§‹èˆ‡æœ€æ–°ç‰ˆé¢å®Œå…¨ä¸€è‡´
        function createNodeElement(item) {
            const div = document.createElement('div');
            div.className = `timeline-item ${item.pos==='left'?'force-left':item.pos==='right'?'force-right':''} ${item.mode==='range'?'range-mode':''}`;
            
            const isMemoClass = item.isMemo ? 'memo-mode' : '';
            const modeBtnText = item.isMemo ? 'â™¾ï¸' : 'ğŸ“…';

            div.innerHTML = `
                <div class="dot"></div>
                <div class="card ${isMemoClass}" data-color="${item.color}">
                    
                    <div class="card-side-tools">
                        <button class="btn-icon side-btn bg-gray" onclick="changeColor(this)" title="æ›è‰²">ğŸ¨</button>
                        <button class="btn-icon side-btn bg-gray" onclick="moveNode(this,'up')" title="ä¸Šç§»">â¬†ï¸</button>
                        <button class="btn-icon side-btn bg-gray" onclick="moveNode(this,'down')" title="ä¸‹ç§»">â¬‡ï¸</button>
                        <button class="btn-icon side-btn bg-gray" onclick="togglePos(this,'left')" title="é å·¦">â¬…ï¸</button>
                        <button class="btn-icon side-btn bg-gray" onclick="togglePos(this,'right')" title="é å³">â¡ï¸</button>
                    </div>

                    <div class="card-top-area">
                        <div class="card-top-left">
                            <input type="checkbox" class="select-chk">
                            <div class="status-dot status-${item.status}" onclick="cycleStatus(this)" title="åˆ‡æ›ç‹€æ…‹"></div>
                        </div>
                        <div class="card-top-right controls">
                            <button class="btn-icon bg-blue" onclick="toggleRange(this)" title="åˆ‡æ›æ™‚æ®µ">â†”ï¸</button>
                            <button class="btn-icon bg-purple" onclick="insertTodoLine(this)" title="æ–°å¢å¾…è¾¦">â˜‘</button>
                            <button class="btn-icon bg-teal" onclick="insertBullet(this)" title="é …ç›®ç¬¦è™Ÿ">ğŸ”¹</button>
                            <button class="btn-icon bg-teal" onclick="addHighlight(this)" title="æ–‡å­—é«˜äº®">ğŸ–ï¸</button>
                            <button class="btn-icon bg-rose" onclick="clearFormatting(this)" title="æ¸…é™¤æ ¼å¼ (æ©¡çš®æ“¦)">ğŸ§¹</button>
                            <button class="btn-icon bg-orange" onclick="copyForTasks(this)" title="è¤‡è£½åˆ°Tasks">ğŸ“‹</button>
                            <button class="btn-icon bg-orange" onclick="addToGoogleCal(this)" title="åŠ åˆ°æ—¥æ›†">ğŸ“…</button>
                            <button class="btn-icon bg-red" onclick="deleteNode(this)" title="åˆªé™¤">Ã—</button>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="header-row">
                            <button class="mode-toggle-btn" onclick="toggleCardMode(this)" title="åˆ‡æ› æ™‚é–“/å‚™å¿˜ æ¨¡å¼">${modeBtnText}</button>

                            <input type="date" class="date-input single-date" value="${item.date_single}" onchange="autoSave()" title="æ—¥æœŸ">
                            <button class="today-btn single-date" onclick="setToday(this)" title="è¨­å®šç‚ºä»Šå¤©">ä»Š</button>
                            <div class="range-container">
                                <span class="range-label">èµ·:</span><input type="date" class="date-input date-start" value="${item.date_start}" onchange="autoSave()">
                                <button class="today-btn" onclick="setToday(this)" title="ä»Š">ä»Š</button>
                                <span class="range-label">è¿„:</span><input type="date" class="date-input date-end" value="${item.date_end}" onchange="autoSave()">
                                <button class="today-btn" onclick="setToday(this)" title="ä»Š">ä»Š</button>
                            </div>
                            <input type="text" class="label-input" value="${item.label}" placeholder="æ¨™é¡Œ" oninput="autoSave()">
                        </div>
                        <div class="content" contenteditable="true" oninput="handleInput(event)">${item.content}</div>
                    </div>

                    <div class="project-footer">
                        <input type="text" class="footer-project-input" autocomplete="off" value="${item.project || ''}" placeholder="ğŸ·ï¸ å°ˆæ¡ˆåç¨±..." oninput="autoSave(); refreshProjectBar();">
                    </div>
                </div>`;
            const contentDiv = div.querySelector('.content');
            contentDiv.addEventListener('paste', handlePaste);
            return div;
        }

        // V44: æ™ºèƒ½ç¹¼æ‰¿å°ˆæ¡ˆå
        document.getElementById('mainAddBtn').addEventListener('click',()=>{
            const t = getTodayString();
            let defaultProj = '';
            if (activeProjectFilters.size === 1) {
                defaultProj = activeProjectFilters.values().next().value;
            }
            container.appendChild(createNodeElement({
                id:Date.now(), pos:'auto', mode:'normal', color:'blue', status:0, project: defaultProj,
                label:'', date_single:t, date_start:t, date_end:t, content:'å…§å®¹...'
            })); 
            window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); 
            autoSave();
        });
        
        function gatherData() {
            const items = []; container.querySelectorAll('.timeline-item').forEach(el => {
                const card=el.querySelector('.card'); const statusEl=el.querySelector('.status-dot');
                let status=0; ['status-1','status-2','status-3'].forEach((c,i)=>{if(statusEl.classList.contains(c))status=i+1;});
                let pos='auto'; if(el.classList.contains('force-left'))pos='left'; if(el.classList.contains('force-right'))pos='right';
                
                items.push({
                    pos, 
                    mode:el.classList.contains('range-mode')?'range':'normal', 
                    isMemo: card.classList.contains('memo-mode'), 
                    color:card.getAttribute('data-color'), 
                    status, 
                    project: el.querySelector('.footer-project-input').value,
                    label:el.querySelector('.label-input').value, 
                    date_single:el.querySelector('.single-date').value, 
                    date_start:el.querySelector('.date-start').value, 
                    date_end:el.querySelector('.date-end').value, 
                    content:el.querySelector('.content').innerHTML
                });
            }); return items;
        }
        function gatherNotes(){const n=[]; document.querySelectorAll('.sticky-note').forEach(el=>{n.push({id:el.id.replace('note-',''),x:el.offsetLeft,y:el.offsetTop,content:el.querySelector('.note-content').value});}); return n;}
        function gatherStickers(){const l=[]; document.querySelectorAll('.sticker').forEach(el=>{l.push({id:el.id.replace('sticker-',''),type:el.dataset.type,x:el.offsetLeft,y:el.offsetTop});}); return l;}
        
        function autoSave() {
            localStorage.setItem('timeline_v44_data', JSON.stringify(gatherData()));
            localStorage.setItem('timeline_v44_notes', JSON.stringify(gatherNotes()));
            localStorage.setItem('timeline_v44_stickers', JSON.stringify(gatherStickers()));
            saveStatus.innerText = 'å·²å„²å­˜'; setTimeout(() => saveStatus.innerText = '', 2000);
        }
        window.downloadJSON=function(){const d={timeline:gatherData(),notes:gatherNotes(),stickers:gatherStickers(),version:'v44'}; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json;charset=utf-8'})); a.download=`timeline_v44_${getTodayString()}.json`; a.click();}
        window.loadJSON=function(inp){const f=inp.files[0]; if(!f)return; const r=new FileReader(); r.onload=function(e){try{const j=JSON.parse(e.target.result); if(j.timeline){renderFromData(j.timeline); if(j.notes)renderNotes(j.notes); if(j.stickers)renderStickers(j.stickers); autoSave(); alert('è®€å–æˆåŠŸ');}}catch(x){alert('æ ¼å¼éŒ¯èª¤');}}; r.readAsText(f);}

        init();
    </script>
</body>
</html>
